(function(e){e.fn.cropzoom=function(t){return this.each(function(){var o=null;var i=null;var a=null;var s=null;var n=null;var r={width:500,height:375,bgColor:"#000",overlayColor:"#000",selector:{x:0,y:0,w:229,h:100,aspectRatio:false,centered:false,borderColor:"yellow",borderColorHover:"red",bgInfoLayer:"#FFF",infoFontSize:10,infoFontColor:"blue",showPositionsOnDrag:true,showDimetionsOnDrag:true,maxHeight:null,maxWidth:null,startWithOverlay:false,hideOverlayOnDragAndResize:true,onSelectorDrag:null,onSelectorDragStop:null,onSelectorResize:null,onSelectorResizeStop:null},image:{source:"",rotation:0,width:0,height:0,minZoom:10,maxZoom:150,startZoom:0,x:0,y:0,useStartZoomAsMinZoom:false,snapToContainer:false,onZoom:null,onRotate:null,onImageDrag:null},enableRotation:true,enableZoom:true,zoomSteps:1,rotationSteps:5,expose:{slidersOrientation:"vertical",zoomElement:"",rotationElement:"",elementMovement:"",movementSteps:5}};var l=e.extend(true,r,t);if(!e.isFunction(e.fn.draggable)||!e.isFunction(e.fn.resizable)||!e.isFunction(e.fn.slider)){alert("You must include ui.draggable, ui.resizable and ui.slider to use cropZoom");return}if(l.image.source==""||l.image.width==0||l.image.height==0){alert("You must set the source, width and height of the image element");return}o=e(this);M("options",l);o.empty();o.css({width:l.width,height:l.height,"background-color":l.bgColor,overflow:"hidden",position:"relative",border:"2px solid #333"});M("image",{h:l.image.height,w:l.image.width,posY:l.image.y,posX:l.image.x,scaleX:0,scaleY:0,rotation:l.image.rotation,source:l.image.source,bounds:[0,0,0,0],id:"image_to_crop_"+o[0].id});c();g();M("selector",{x:l.selector.x,y:l.selector.y,w:l.selector.maxWidth!=null?l.selector.w>l.selector.maxWidth?l.selector.maxWidth:l.selector.w:l.selector.w,h:l.selector.maxHeight!=null?l.selector.h>l.selector.maxHeight?l.selector.maxHeight:l.selector.h:l.selector.h});$container=e("<div />").attr("id","k").css({width:l.width,height:l.height,position:"absolute"});s=e("<img />");s.attr("src",l.image.source);e(s).css({position:"absolute",left:Y("image").posX,top:Y("image").posY,width:Y("image").w,height:Y("image").h});var m=h();if(m=="png"||m=="gif")s[0].style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+l.image.source+"',sizingMethod='scale');";$container.append(s);o.append($container);u();e(s).draggable({refreshPositions:true,drag:function(e,t){Y("image").posY=t.position.top;Y("image").posX=t.position.left;if(l.image.snapToContainer)d(t);else u();if(l.image.onImageDrag!=null)l.image.onImageDrag(s)},stop:function(e,t){if(l.image.snapToContainer)d(t)}});w();o.find(".ui-icon-gripsmall-diagonal-se").css({background:"#FFF",border:"1px solid #000",width:8,height:8});y();if(l.selector.startWithOverlay){var p={position:{top:a.position().top,left:a.position().left}};S(p)}if(l.enableZoom)v();if(l.enableRotation)f();if(l.expose.elementMovement!="")O();function d(e){if(e.position.top>0)Y("image").posY=0;if(e.position.left>0)Y("image").posX=0;var t=-(Y("image").h-e.helper.parent().parent().height()),o=-(Y("image").w-e.helper.parent().parent().width());if(e.position.top<t)Y("image").posY=t;if(e.position.left<o)Y("image").posX=o;u()}function h(){var e=l.image.source.split(".");return e[e.length-1]}function c(){Y("image").scaleX=l.width/Y("image").w;Y("image").scaleY=l.height/Y("image").h}function g(){if(l.image.startZoom!=0){var e=l.image.width*Math.abs(l.image.startZoom)/100;var t=l.image.height*Math.abs(l.image.startZoom)/100;Y("image").h=t;Y("image").w=e;if(Y("image").posY!=0&&Y("image").posX!=0){if(Y("image").h>l.height)Y("image").posY=Math.abs(l.height/2-Y("image").h/2);else Y("image").posY=l.height/2-Y("image").h/2;if(Y("image").w>l.width)Y("image").posX=Math.abs(l.width/2-Y("image").w/2);else Y("image").posX=l.width/2-Y("image").w/2}}else{var o=Y("image").scaleX;var i=Y("image").scaleY;if(i<o){Y("image").h=l.height;Y("image").w=Math.round(Y("image").w*i)}else{Y("image").h=Math.round(Y("image").h*o);Y("image").w=l.width}}if(Y("image").w<l.width&&Y("image").h<l.height){l.image.snapToContainer=false}u()}function u(){e(function(){X();rotation="rotate("+Y("image").rotation+"deg)";e(s).css({transform:rotation,"-webkit-transform":rotation,"-ms-transform":rotation,msTransform:rotation,top:Y("image").posY,left:Y("image").posX})})}function f(){var t=e("<div />").attr("id","rotationContainer").mouseover(function(){e(this).css("opacity",1)}).mouseout(function(){e(this).css("opacity",.6)});var i=e("<div />").attr("id","rotationMin").html("0");var a=e("<div />").attr("id","rotationMax").html("360");var s=e("<div />").attr("id","rotationSlider");var n="vertical";var r=Math.abs(360-l.image.rotation);if(l.expose.slidersOrientation=="horizontal"){n="horizontal";r=l.image.rotation}s.slider({orientation:n,value:r,range:"max",min:0,max:360,step:l.rotationSteps>360||l.rotationSteps<0?1:l.rotationSteps,slide:function(e,t){Y("image").rotation=r==360?Math.abs(360-t.value):Math.abs(t.value);u();if(l.image.onRotate!=null)l.image.onRotate(s,Y("image").rotation)}});t.append(i);t.append(s);t.append(a);if(l.expose.rotationElement!=""){s.addClass(l.expose.slidersOrientation);t.addClass(l.expose.slidersOrientation);i.addClass(l.expose.slidersOrientation);a.addClass(l.expose.slidersOrientation);e(l.expose.rotationElement).empty().append(t)}else{s.addClass("vertical");t.addClass("vertical");i.addClass("vertical");a.addClass("vertical");t.css({position:"absolute",top:5,left:5,opacity:.6});o.append(t)}}function v(){var t=e("<div />").attr("id","zoomContainer").mouseover(function(){e(this).css("opacity",1)}).mouseout(function(){e(this).css("opacity",.6)});var i=e("<div />").attr("id","zoomMin").html("<b>-</b>");var a=e("<div />").attr("id","zoomMax").html("<b>+</b>");var n=e("<div />").attr("id","zoomSlider");n.slider({orientation:l.expose.zoomElement!=""?l.expose.slidersOrientation:"vertical",value:l.image.startZoom!=0?l.image.startZoom:x(Y("image")),min:l.image.useStartZoomAsMinZoom?l.image.startZoom:l.image.minZoom,max:l.image.maxZoom,step:l.zoomSteps>l.image.maxZoom||l.zoomSteps<0?1:l.zoomSteps,slide:function(t,o){var i=l.expose.slidersOrientation=="vertical"?l.image.maxZoom-o.value:o.value;var a=l.image.width*Math.abs(i)/100;var n=l.image.height*Math.abs(i)/100;e(s).css({width:a+"px",height:n+"px"});var r=Y("image").w/2-a/2;var m=Y("image").h/2-n/2;var p=r>0?Y("image").posX+Math.abs(r):Y("image").posX-Math.abs(r);var d=m>0?Y("image").posY+Math.abs(m):Y("image").posY-Math.abs(m);Y("image").posX=p;Y("image").posY=d;Y("image").w=a;Y("image").h=n;c();u();if(l.image.onZoom!=null){l.image.onZoom(s,Y("image"))}}});if(l.slidersOrientation=="vertical"){t.append(a);t.append(n);t.append(i)}else{t.append(i);t.append(n);t.append(a)}if(l.expose.zoomElement!=""){i.addClass(l.expose.slidersOrientation);a.addClass(l.expose.slidersOrientation);n.addClass(l.expose.slidersOrientation);t.addClass(l.expose.slidersOrientation);e(l.expose.zoomElement).empty().append(t)}else{i.addClass("vertical");a.addClass("vertical");n.addClass("vertical");t.addClass("vertical");t.css({position:"absolute",top:5,right:5,opacity:.6});o.append(t)}}function x(){var e=0;if(Y("image").w>Y("image").h){e=l.image.maxZoom-Y("image").w*100/l.image.width}else{e=l.image.maxZoom-Y("image").h*100/l.image.height}return e}function w(){if(l.selector.centered){Y("selector").y=l.height/2-Y("selector").h/2;Y("selector").x=l.width/2-Y("selector").w/2}a=e("<div/>").attr("id",o[0].id+"_selector").css({width:Y("selector").w,height:Y("selector").h,top:Y("selector").y+"px",left:Y("selector").x+"px",border:"1px dashed "+l.selector.borderColor,position:"absolute",cursor:"move"}).mouseover(function(){e(this).css({border:"1px dashed "+l.selector.borderColorHover})}).mouseout(function(){e(this).css({border:"1px dashed "+l.selector.borderColor})});a.draggable({containment:"parent",iframeFix:true,refreshPositions:true,drag:function(e,t){Y("selector").x=t.position.left;Y("selector").y=t.position.top;S(t);b();if(l.selector.onSelectorDrag!=null)l.selector.onSelectorDrag(a,Y("selector"))},start:function(e,t){if(l.selector.hideOverlayOnDragAndResize)C()},stop:function(e,t){if(l.selector.hideOverlayOnDragAndResize)z();if(l.selector.onSelectorDragStop!=null)l.selector.onSelectorDragStop(a,Y("selector"))}});a.resizable({aspectRatio:l.selector.aspectRatio,maxHeight:l.selector.maxHeight,maxWidth:l.selector.maxWidth,minHeight:l.selector.h,minWidth:l.selector.w,containment:"parent",resize:function(e,t){Y("selector").w=a.width();Y("selector").h=a.height();S(t);b();if(l.selector.onSelectorResize!=null)l.selector.onSelectorResize(a,Y("selector"))},start:function(e,t){if(l.selector.hideOverlayOnDragAndResize)C()},stop:function(e,t){if(l.selector.hideOverlayOnDragAndResize)z();if(l.selector.onSelectorResizeStop!=null)l.selector.onSelectorResizeStop(a,Y("selector"))}});b(a);o.append(a)}function b(){var t=null;var o=false;if(a.find("#infoSelector").length>0){t=a.find("#infoSelector")}else{t=e("<div />").attr("id","infoSelector").css({position:"absolute",top:0,left:0,background:l.selector.bgInfoLayer,opacity:.6,"font-size":l.selector.infoFontSize+"px","font-family":"Arial",color:l.selector.infoFontColor,width:"100%"})}if(l.selector.showPositionsOnDrag){t.html("X:"+Math.round(Y("selector").x)+"px - Y:"+Math.round(Y("selector").y)+"px");o=true}if(l.selector.showDimetionsOnDrag){if(o){t.html(t.html()+" | W:"+Y("selector").w+"px - H:"+Y("selector").h+"px")}else{t.html("W:"+Y("selector").w+"px - H:"+Y("selector").h+"px")}}a.append(t)}function y(){var t=["t","b","l","r"];e.each(t,function(){var t=e("<div />").attr("id",this).css({overflow:"hidden",background:l.overlayColor,opacity:.6,position:"absolute","z-index":2,visibility:"visible"});o.append(t)})}function S(e){o.find("#t").css({width:l.width,height:e.position.top,left:0,top:0});o.find("#b").css({width:l.width,height:l.height,top:e.position.top+a.height()+"px",left:0});o.find("#l").css({left:0,top:e.position.top,width:e.position.left,height:a.height()});o.find("#r").css({top:e.position.top,left:e.position.left+a.width()+"px",width:l.width,height:a.height()+"px"})}o.makeOverlayPositions=S;function C(){o.find("#t").hide();o.find("#b").hide();o.find("#l").hide();o.find("#r").hide()}function z(){o.find("#t").show();o.find("#b").show();o.find("#l").show();o.find("#r").show()}function M(e,t){o.data(e,t)}function Y(e){return o.data(e)}function X(){var e=Y("image").rotation*Math.PI/180;var t=Math.sin(e);var o=Math.cos(e);var i=o*Y("image").w;var a=t*Y("image").w;var s=-t*Y("image").h;var n=o*Y("image").h;var r=o*Y("image").w-t*Y("image").h;var l=t*Y("image").w+o*Y("image").h;var m=Math.min(0,i,s,r);var p=Math.max(0,i,s,r);var d=Math.min(0,a,n,l);var h=Math.max(0,a,n,l);Y("image").rotW=p-m;Y("image").rotH=h-d;Y("image").rotY=d;Y("image").rotX=m}function O(){var t=e("<table>                                    <tr>                                    <td></td>                                    <td></td>                                    <td></td>                                    </tr>                                    <tr>                                    <td></td>                                    <td></td>                                    <td></td>                                    </tr>                                    <tr>                                    <td></td>                                    <td></td>                                    <td></td>                                    </tr>                                    </table>");var o=[];o.push(e("<div />").addClass("mvn_no mvn"));o.push(e("<div />").addClass("mvn_n mvn"));o.push(e("<div />").addClass("mvn_ne mvn"));o.push(e("<div />").addClass("mvn_o mvn"));o.push(e("<div />").addClass("mvn_c"));o.push(e("<div />").addClass("mvn_e mvn"));o.push(e("<div />").addClass("mvn_so mvn"));o.push(e("<div />").addClass("mvn_s mvn"));o.push(e("<div />").addClass("mvn_se mvn"));for(var a=0;a<o.length;a++){o[a].mousedown(function(){_(this)}).mouseup(function(){clearTimeout(i)}).mouseout(function(){clearTimeout(i)});t.find("td:eq("+a+")").append(o[a])}e(l.expose.elementMovement).empty().append(t)}function _(t){if(e(t).hasClass("mvn_no")){Y("image").posX=Y("image").posX-l.expose.movementSteps;Y("image").posY=Y("image").posY-l.expose.movementSteps}else if(e(t).hasClass("mvn_n")){Y("image").posY=Y("image").posY-l.expose.movementSteps}else if(e(t).hasClass("mvn_ne")){Y("image").posX=Y("image").posX+l.expose.movementSteps;Y("image").posY=Y("image").posY-l.expose.movementSteps}else if(e(t).hasClass("mvn_o")){Y("image").posX=Y("image").posX-l.expose.movementSteps}else if(e(t).hasClass("mvn_c")){Y("image").posX=l.width/2-Y("image").w/2;Y("image").posY=l.height/2-Y("image").h/2}else if(e(t).hasClass("mvn_e")){Y("image").posX=Y("image").posX+l.expose.movementSteps}else if(e(t).hasClass("mvn_so")){Y("image").posX=Y("image").posX-l.expose.movementSteps;Y("image").posY=Y("image").posY+l.expose.movementSteps}else if(e(t).hasClass("mvn_s")){Y("image").posY=Y("image").posY+l.expose.movementSteps}else if(e(t).hasClass("mvn_se")){Y("image").posX=Y("image").posX+l.expose.movementSteps;Y("image").posY=Y("image").posY+l.expose.movementSteps}if(l.image.snapToContainer){if(Y("image").posY>0){Y("image").posY=0}if(Y("image").posX>0){Y("image").posX=0}var a=-(Y("image").h-o.height());var s=-(Y("image").w-o.width());if(Y("image").posY<a){Y("image").posY=a}if(Y("image").posX<s){Y("image").posX=s}}u();i=setTimeout(function(){_(t)},100)}e.fn.cropzoom.updateOverlayPosition=function(e){o.makeOverlayPositions(e)};e.fn.cropzoom.getParameters=function(t,o){var i=t.data("image");var a=t.data("selector");var s={viewPortW:t.width(),viewPortH:t.height(),imageX:i.posX,imageY:i.posY,imageRotate:i.rotation,imageW:i.w,imageH:i.h,imageSource:i.source,selectorX:a.x,selectorY:a.y,selectorW:a.w,selectorH:a.h};return e.extend(s,o)};e.fn.cropzoom.getSelf=function(){return o};return this})};e.fn.extend({cropZoomSetSelector:function(t,o,i,a,s){var n=e(this);n.data("selector",{x:t,y:o,w:i,h:a});var r={position:{top:o,left:t}};if(s!=undefined&&s==true){n.find("#"+n[0].id+"_selector").animate({top:o,left:t,width:i,height:a},"slow",function(){if(n.data("options").selector.startWithOverlay){n.cropzoom.updateOverlayPosition(r)}})}else{n.find("#"+n[0].id+"_selector").css({top:o,left:t,width:i,height:a});if(e(this).data("options").selector.startWithOverlay){n.cropzoom.updateOverlayPosition(r)}}},cropZoomRestore:function(){var t=e(this);var o=t.data("options");t.empty();t.data("image",{});t.data("selector",{});if(o.expose.zoomElement!=""){e(o.expose.zoomElement).empty()}if(o.expose.rotationElement!=""){e(o.expose.rotationElement).empty()}if(o.expose.elementMovement!=""){e(o.expose.elementMovement).empty()}t.cropzoom(o)},cropZoomSend:function(t,o,i,a){var s=e(this);var n="";e.ajax({url:t,type:o,data:s.cropzoom.getParameters(s,i),success:function(e){s.data("imageResult",e);if(a!==undefined&&a!=null)a(e)}})}})})(jQuery);(function(e){e.support.touch="ontouchend"in document;if(!e.support.touch){return}var t=e.ui.mouse.prototype,o=t._mouseInit,i;function a(e,t){if(e.originalEvent.touches.length>1){return}e.preventDefault();var o=e.originalEvent.changedTouches[0],i=document.createEvent("MouseEvents");i.initMouseEvent(t,true,true,window,1,o.screenX,o.screenY,o.clientX,o.clientY,false,false,false,false,0,null);e.target.dispatchEvent(i)}t._touchStart=function(e){var t=this;if(i||!t._mouseCapture(e.originalEvent.changedTouches[0])){return}i=true;t._touchMoved=false;a(e,"mouseover");a(e,"mousemove");a(e,"mousedown")};t._touchMove=function(e){if(!i){return}this._touchMoved=true;a(e,"mousemove")};t._touchEnd=function(e){if(!i){return}a(e,"mouseup");a(e,"mouseout");if(!this._touchMoved){a(e,"click")}i=false};t._mouseInit=function(){var t=this;t.element.bind("touchstart",e.proxy(t,"_touchStart")).bind("touchmove",e.proxy(t,"_touchMove")).bind("touchend",e.proxy(t,"_touchEnd"));o.call(t)}})(jQuery);