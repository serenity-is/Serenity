<Project>
  <PropertyGroup>
    <DotNetSergen Condition="'$(DotNetSergen)' == '' And Exists('$(MSBuildThisFileDirectory)..\..\artifacts\sergen\sergen')">$(MSBuildThisFileDirectory)..\..\artifacts\sergen\sergen</DotNetSergen>
    <DotNetSergen Condition="'$(DotNetSergen)' == '' And Exists('$(MSBuildThisFileDirectory)..\..\artifacts\sergen\sergen.exe')">$(MSBuildThisFileDirectory)..\..\artifacts\sergen\sergen.exe</DotNetSergen>
    <DotNetSergen Condition="'$(DotNetSergen)' == '' And Exists('$(MSBuildThisFileDirectory)..\codegenerator\Serenity.Net.CodeGenerator.csproj')">dotnet run --project $(MSBuildThisFileDirectory)..\codegenerator\Serenity.Net.CodeGenerator.csproj -- </DotNetSergen>
    <DotNetSergen Condition="'$(DotNetSergen)' == ''">dotnet sergen</DotNetSergen>
  </PropertyGroup>
  <UsingTask TaskName="RestoreNodeTypesTask" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <FolderNames ParameterType="System.String" />
      <PatchDependencies ParameterType="System.String" />
    </ParameterGroup>
    <Task>
      <Code Type="Class" Language="cs" Source="$(MSBuildThisFileDirectory)RestoreNodeTypesTask.cs" />
    </Task>
  </UsingTask>
  <PropertyGroup>
    <RestoreNodeTypes Condition="'$(RestoreNodeTypes)' == '' And Exists('$(MSBuildProjectDirectory)\tsconfig.json')">true</RestoreNodeTypes>
    <CompileTypeScriptDependsOn Condition="'$(RestoreNodeTypes)' != 'false'">RestoreNodeTypes;$(CompileTypeScriptDependsOn)</CompileTypeScriptDependsOn>
  </PropertyGroup>
  <ItemGroup>
    <Content Remove="texts\resources\**\*.json" />
    <EmbeddedResource Include="texts\resources\**\*.json" WithCulture="false" Culture="" />
    <AssemblyAttribute Include="Serenity.ComponentModel.TypeSourceAssemblyAttribute" />
  </ItemGroup>
  <Target Name="RestoreNodeTypes" DependsOnTargets="ResolvePackageAssets;IncludeTransitiveProjectReferences" BeforeTargets="BeforeBuild" Condition="'$(RestoreNodeTypes)' != 'false'">
    <ItemGroup>
      <!--from package references-->
      <_NodeTypePackageDotnet Include="%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\package.json"
        Condition="'%(RuntimeCopyLocalItems.NuGetPackageId)' != '' And Exists('%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\package.json')
          And (Exists('%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\dist\index.js') 
            Or '$([System.IO.File]::ReadAllText(`%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\package.json`).Contains(`./wwwroot/`))' == 'True')">
        <FolderName>$([System.String]::Copy('%(RuntimeCopyLocalItems.NuGetPackageId)').ToLowerInvariant())</FolderName>
      </_NodeTypePackageDotnet>
      <_NodeTypeCopyFiles Include="%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\dist\**\*.*"
        Condition="'%(RuntimeCopyLocalItems.NuGetPackageId)' != ''">
        <FolderName>$([System.String]::Copy('%(RuntimeCopyLocalItems.NuGetPackageId)').ToLowerInvariant())</FolderName>
        <SubDir>dist\</SubDir>
      </_NodeTypeCopyFiles>
      <_NodeTypeCopyFiles Include="%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\staticwebassets\**\*.*"
        Exclude="%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\staticwebassets\**\*.d.ts;%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\staticwebassets\esm\**"
        Condition="'%(RuntimeCopyLocalItems.NuGetPackageId)' != '' 
          And Exists('%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\package.json')
          And '$([System.IO.File]::ReadAllText(`%(RuntimeCopyLocalItems.RootDir)%(Directory)..\..\package.json`).Contains(`./wwwroot/`))' == 'True'">
        <FolderName>$([System.String]::Copy('%(RuntimeCopyLocalItems.NuGetPackageId)').ToLowerInvariant())</FolderName>
        <SubDir>wwwroot\</SubDir>
      </_NodeTypeCopyFiles>

      <!--from project references-->
      <_NodeTypePackageDotnet Include="%(ProjectReference.RootDir)%(Directory)package.json"
        Condition="Exists('%(ProjectReference.RootDir)%(Directory)package.json')
          And (Exists('%(ProjectReference.RootDir)%(Directory)dist\index.js') 
            Or '$([System.IO.File]::ReadAllText(`%(ProjectReference.RootDir)%(Directory)package.json`).Contains(`./wwwroot/`))' == 'True')">
        <FolderName>$([System.String]::Copy('%(ProjectReference.Filename)').ToLowerInvariant())</FolderName>
      </_NodeTypePackageDotnet>
      <_NodeTypeCopyFiles Include="%(ProjectReference.RootDir)%(Directory)dist\**\*.*">
        <FolderName>$([System.String]::Copy('%(ProjectReference.Filename)').ToLowerInvariant())</FolderName>
        <SubDir>dist\</SubDir>
      </_NodeTypeCopyFiles>
      <_NodeTypeCopyFiles Include="%(ProjectReference.RootDir)%(Directory)wwwroot\**\*.*"
        Exclude="%(ProjectReference.RootDir)%(Directory)wwwroot\**\*.d.ts;%(ProjectReference.RootDir)%(Directory)wwwroot\esm\**"
        Condition="Exists('%(ProjectReference.RootDir)%(Directory)package.json')  
          And '$([System.IO.File]::ReadAllText(`%(ProjectReference.RootDir)%(Directory)package.json`).Contains(`./wwwroot/`))' == 'True'">
        <FolderName>$([System.String]::Copy('%(ProjectReference.Filename)').ToLowerInvariant())</FolderName>
        <SubDir>wwwroot\</SubDir>
      </_NodeTypeCopyFiles>
    </ItemGroup>
    <Copy SourceFiles="@(_NodeTypePackageDotnet)" DestinationFiles="@(_NodeTypePackageDotnet->'node_modules\.dotnet\%(FolderName)\package.dotnet.json')" SkipUnchangedFiles="true"  UseHardlinksIfPossible="true" />
    <RestoreNodeTypesTask FolderNames="@(_NodeTypeCopyFiles->'%(FolderName)'->Distinct())" PatchDependencies="$(RestoreNodeTypesPatchDependencies)" ContinueOnError="true" />
    <ItemGroup>
      <_NodeTypeDeleteFiles Include="node_modules\.dotnet\**\*.*" Exclude="@(_NodeTypeCopyFiles->'node_modules\.dotnet\%(FolderName)%(SubDir)(RecursiveDir)%(Filename)%(Extension)');@(_NodeTypeCopyFiles->'node_modules\.dotnet\%(FolderName)\package.json'->Distinct());@(_NodeTypePackageDotnet->'node_modules\.dotnet\%(FolderName)\package.dotnet.json'->Distinct())" />
    </ItemGroup>
    <Delete Files="@(_NodeTypeDeleteFiles)" />
    <Copy SourceFiles="@(_NodeTypeCopyFiles)" DestinationFiles="@(_NodeTypeCopyFiles->'node_modules\.dotnet\%(FolderName)\%(SubDir)%(RecursiveDir)%(Filename)%(Extension)')" SkipUnchangedFiles="true" UseHardlinksIfPossible="true" />
  </Target>
  <Target Name="SetSergenTransformArgs">
    <ItemGroup>
      <SergenGlobalUsing Include="@(Using)" Condition="'%(Using.Alias)' == '' And '%(Using.Static)' != 'true'" />
    </ItemGroup>
    <PropertyGroup>
      <SergenTransformArgs>-p &quot;$(ProjectFileName)&quot; -prop:Configuration=$(Configuration) -prop:AssemblyName=&quot;$(AssemblyName)&quot; -prop:ESMAssetBasePath=&quot;$(ESMAssetBasePath)&quot; -globalusings &quot;@(SergenGlobalUsing->'%(Identity)')&quot; -prop:OutDir=&quot;$(OutDir.Trim('\').Replace("\", "/"))&quot; -prop:RootNamespace=$(RootNamespace) -prop:TargetFramework=$(TargetFramework)</SergenTransformArgs>
    </PropertyGroup>
    <Message Importance="normal" Text="Transform Arguments: $(SergenTransformArgs)"/>
  </Target>
  <ItemGroup Condition="'$(SerenityUsings)' != 'false'">
    <Using Include="Microsoft.AspNetCore.Mvc" />
    <Using Include="Microsoft.Extensions.Logging" />
    <Using Include="Microsoft.Extensions.Options" />
    <Using Include="Serenity" />
    <Using Include="Serenity.Abstractions" />
    <Using Include="Serenity.ComponentModel" />
    <Using Include="Serenity.Data" />

    <Using Include="Serenity.Data.Mapping" />
    <Using Include="Serenity.Extensions" />
    <Using Include="Serenity.Navigation" />
    <Using Include="Serenity.Services" />
    <Using Include="Serenity.Web" />
    <Using Include="System" />
    <Using Include="System.Collections.Generic" />
    <Using Include="System.ComponentModel" />
    <Using Include="System.Data.IDbConnection" Alias="IDbConnection" />
    <Using Include="System.Data.Common.DbProviderFactories" Alias="DbProviderFactories" />
    <Using Include="System.Globalization.CultureInfo" Alias="CultureInfo" />
    <Using Include="System.Globalization.DateTimeStyles" Alias="DateTimeStyles" />
    <Using Include="System.Globalization.NumberStyles" Alias="NumberStyles" />
    <Using Include="System.Linq" />
    <Using Include="System.Text" />
    <Using Include="System.Text.RegularExpressions" />
    <Using Include="System.Threading" />
    <Using Include="System.Threading.Tasks" />
  </ItemGroup>
</Project>
