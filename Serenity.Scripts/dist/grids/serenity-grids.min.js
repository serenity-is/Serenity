var Serenity;(function(e){var t=function(e){__extends(t,e);function t(t,i){var r=e.call(this,Q.extend({showRowsPerPage:true,rowsPerPageOptions:[20,100,500,2e3]},i))||this;i=r.options;var n=i.view;if(!n)throw"SlickPager requires view option to be set!";r.element.addClass("s-SlickPager slick-pg").html('<div class="slick-pg-in">'+'<div class="slick-pg-grp">'+'<div class="slick-pg-first slick-pg-btn"><span class="slick-pg-btn-span"></span></div>'+'<div class="slick-pg-prev slick-pg-btn"><span class="slick-pg-btn-span"></span></div>'+'</div><div class="slick-pg-sep"></div><div class="slick-pg-grp">'+'<span class="slick-pg-control">&nbsp;'+Q.text("Controls.Pager.Page")+'&nbsp;<input class="slick-pg-current" type="text" size="4" value="1" /> / '+'<span class="slick-pg-total"> 1 </span></span>'+'</div><div class="slick-pg-sep"></div><div class="slick-pg-grp">'+'<div class="slick-pg-next slick-pg-btn"><span class="slick-pg-btn-span"></span></div>'+'<div class="slick-pg-last slick-pg-btn"><span class="slick-pg-btn-span"></span></div>'+'</div><div class="slick-pg-sep"></div><div class="slick-pg-grp">'+'<div class="slick-pg-reload slick-pg-btn"><span class="slick-pg-btn-span"></span></div>'+'</div><div class="slick-pg-sep"></div>'+'<div class="slick-pg-grp"><span class="slick-pg-stat"></span></div></div>');var l=r;$(".slick-pg-reload",r.element).click(function(){n.populate()});$(".slick-pg-first",r.element).click(function(){l._changePage("first")});$(".slick-pg-prev",r.element).click(function(){l._changePage("prev")});$(".slick-pg-next",r.element).click(function(){l._changePage("next")});$(".slick-pg-last",r.element).click(function(){l._changePage("last")});$(".slick-pg-current",r.element).keydown(function(e){if(e.keyCode==13)l._changePage("input")});if(l.options.showRowsPerPage){var s,o="";for(var a=0;a<i.rowsPerPageOptions.length;a++){if(n.rowsPerPage==i.rowsPerPageOptions[a])o='selected="selected"';else o="";s+="<option value='"+i.rowsPerPageOptions[a]+"' "+o+" >"+i.rowsPerPageOptions[a]+"&nbsp;&nbsp;</option>"}$(".slick-pg-in",r.element).prepend('<div class="slick-pg-grp"><select class="slick-pg-size" name="rp">'+s+'</select></div><div class="slick-pg-sep"></div>');$("select.slick-pg-size",r.element).change(function(){if(i.onRowsPerPageChange)i.onRowsPerPageChange(+this.value);else{n["newp"]=1;n.setPagingOptions({page:1,rowsPerPage:+this.value})}})}n.onPagingInfoChanged.subscribe(function(){l._updatePager()});return r}t.prototype._changePage=function(e){var t=this.options.view;if(!t||t.loading)return true;var i=t.getPagingInfo();var r=!i.rowsPerPage||!i.totalCount?1:Math.ceil(i.totalCount/i.rowsPerPage);var n;switch(e){case"first":n=1;break;case"prev":if(i.page>1)n=parseInt(i.page)-1;break;case"next":if(i.page<r)n=parseInt(i.page)+1;break;case"last":n=r;break;case"input":var l=parseInt($("input.slick-pg-current",this.element).val());if(isNaN(l))l=1;else if(l<1)l=1;else if(l>r)l=r;$(".slick-pg-current",this.element).val(l);n=l;break}if(n==i.page)return false;if(this.options.onChangePage)this.options.onChangePage(n);else{t.setPagingOptions({page:n})}};t.prototype._updatePager=function(){var e=this.options.view;var t=e.getPagingInfo();var i=!t.rowsPerPage||!t.totalCount?1:Math.ceil(t.totalCount/t.rowsPerPage);$(".slick-pg-current",this.element).val(t.page);$(".slick-pg-total",this.element).html(i);var r=(t.page-1)*t.rowsPerPage+1;var n=r+t.rowsPerPage-1;if(t.totalCount<n)n=t.totalCount;var l;if(t.loading){l=Q.text("Controls.Pager.LoadingStatus")}else if(t.error){l=t.error}else if(t.totalCount>0){l=Q.text("Controls.Pager.PageStatus");l=l.replace(/{from}/,r);l=l.replace(/{to}/,n);l=l.replace(/{total}/,t.totalCount)}else l=Q.text("Controls.Pager.NoRowStatus");$(".slick-pg-stat",this.element).html(l);$(".slick-pg-size",this.element).val((t.rowsPerPage||0).toString())};return t}(e.Widget);e.SlickPager=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(){function t(e,t){var i=this;this.include={};this.grid=e;this.idField=e.getView().idField;this.options=t||{};e.getGrid().onClick.subscribe(function(t,r){if($(t.target).hasClass("select-item")){t.preventDefault();var n=e.getView().getItem(r.row);var l=n[i.idField].toString();if(i.include[l]){delete i.include[l]}else{i.include[l]=true}for(var s=0;s<e.getView().getLength();s++){e.getGrid().updateRow(s)}i.updateSelectAll()}});e.getGrid().onHeaderClick.subscribe(function(t,r){if(t.isDefaultPrevented()){return}if($(t.target).hasClass("select-all-items")){t.preventDefault();var n=e.getView();if(Object.keys(i.include).length>0){Q.clearKeys(i.include)}else{var l=e.getView().getItems();for(var s=0,o=l.filter(i.isSelectable.bind(i));s<o.length;s++){var a=o[s];var u=a[i.idField];i.include[u]=true}}i.updateSelectAll();e.getView().setItems(e.getView().getItems(),true)}});e.getView().onRowsChanged.subscribe(function(){return i.updateSelectAll()})}t.prototype.updateSelectAll=function(){var e=this.grid.getElement().find(".select-all-header .slick-column-name .select-all-items");if(e){var t=Object.keys(this.include);e.toggleClass("checked",t.length>0&&this.grid.getView().getItems().filter(this.isSelectable.bind(this)).length<=t.length)}};t.prototype.clear=function(){Q.clearKeys(this.include);this.updateSelectAll()};t.prototype.resetCheckedAndRefresh=function(){this.include={};this.updateSelectAll();this.grid.getView().populate()};t.prototype.selectKeys=function(e){for(var t=0,i=e;t<i.length;t++){var r=i[t];this.include[r]=true}this.updateSelectAll()};t.prototype.getSelectedKeys=function(){return Object.keys(this.include)};t.prototype.getSelectedAsInt32=function(){return Object.keys(this.include).map(function(e){return parseInt(e,10)})};t.prototype.getSelectedAsInt64=function(){return Object.keys(this.include).map(function(e){return parseInt(e,10)})};t.prototype.setSelectedKeys=function(e){this.clear();for(var t=0,i=e;t<i.length;t++){var r=i[t];this.include[r]=true}this.updateSelectAll()};t.prototype.isSelectable=function(e){return e&&(this.options.selectable==null||this.options.selectable(e))};t.createSelectColumn=function(e){return{name:'<span class="select-all-items check-box no-float "></span>',toolTip:" ",field:"__select__",width:27,minWidth:27,headerCssClass:"select-all-header",sortable:false,format:function(t){var i=t.item;var r=e();if(!r||!r.isSelectable(i)){return""}var n=r.include[t.item[r.idField]];return'<span class="select-item check-box no-float '+(n?" checked":"")+'"></span>'}}};t=__decorate([e.Decorators.registerClass("Serenity.GridRowSelectionMixin")],t);return t}();e.GridRowSelectionMixin=t;var i=function(){function t(e,t){var i=this;this.include={};this.grid=e;this.idField=e.getView().idField;this.options=t||{};e.getGrid().onClick.subscribe(function(t,r){if($(t.target).hasClass("rad-select-item")){t.preventDefault();var n=e.getView().getItem(r.row);if(!i.isSelectable(n)){return}var l=n[i.idField].toString();if(i.include[l]==true){Q.clearKeys(i.include)}else{Q.clearKeys(i.include);i.include[l]=true}for(var s=0;s<e.getView().getLength();s++){e.getGrid().updateRow(s)}}})}t.prototype.isSelectable=function(e){return e&&(this.options.selectable==null||this.options.selectable(e))};t.prototype.clear=function(){Q.clearKeys(this.include)};t.prototype.resetCheckedAndRefresh=function(){this.include={};this.grid.getView().populate()};t.prototype.getSelectedKey=function(){var e=Object.keys(this.include);if(e!=null&&e.length>0){return e[0]}return null};t.prototype.getSelectedAsInt32=function(){var e=Object.keys(this.include).map(function(e){return parseInt(e,10)});if(e!=null&&e.length>0){return e[0]}return null};t.prototype.getSelectedAsInt64=function(){var e=Object.keys(this.include).map(function(e){return parseInt(e,10)});if(e!=null&&e.length>0){return e[0]}return null};t.prototype.setSelectedKey=function(e){this.clear();this.include[e]=true};t.createSelectColumn=function(e){return{name:"",toolTip:" ",field:"__select__",width:27,minWidth:27,headerCssClass:"",sortable:false,formatter:function(t,i,r,n,l){var s=e();if(!s||!s.isSelectable(l)){return""}var o=s.include[l[s.idField]];return'<input type="radio" name="radio-selection-group" class="rad-select-item no-float" style="cursor: pointer;width: 13px; height:13px;" '+(o?" checked":"")+" /> "}}};t=__decorate([e.Decorators.registerClass("Serenity.GridRadioSelectionMixin")],t);return t}();e.GridRadioSelectionMixin=i;var r;(function(t){function i(t,i){var r=t.element.children(".s-Toolbar");if(r.length===0){return}var n=r.getWidget(e.Toolbar).findButton("select-all-button");var l=t.getView().getItems();n.toggleClass("checked",l.length>0&&!l.some(function(e){return!i(e)}))}t.update=i;function r(t,i,r,n,l,s){if(l==null){l=Q.coalesce(Q.tryGetText("Controls.CheckTreeEditor.SelectAll"),"Select All")}return{title:l,cssClass:"select-all-button",onClick:function(){var r=t();var l=r.getView();var o=r.element.children(".s-Toolbar").getWidget(e.Toolbar).findButton("select-all-button");var a=!o.hasClass("checked");l.beginUpdate();try{for(var u=0,c=l.getItems();u<c.length;u++){var d=c[u];n(d,a);l.updateItem(i(d),d)}s&&s()}finally{l.endUpdate()}o.toggleClass("checked",a)}}}t.define=r})(r=e.GridSelectAllButtonHelper||(e.GridSelectAllButtonHelper={}));var n;(function(t){function i(e,t,i,r,n){var l=$('<div><a href="#"></a></div>').addClass("s-ToggleButton").addClass(t).prependTo(e);l.children("a").click(function(e){e.preventDefault();l.toggleClass("pressed");var t=l.hasClass("pressed");i&&i(t)}).attr("title",Q.coalesce(r,""));if(n){l.addClass("pressed")}}t.addToggleButton=i;function r(e,t,r,n){var l=false;var s=t.onSubmit;t.onSubmit=function(e){e.params.IncludeDeleted=l;if(s!=null){return s(e)}return true};if(r==null)r=Q.text("Controls.EntityGrid.IncludeDeletedToggle");i(e,"s-IncludeDeletedToggle",function(e){l=e;t.seekToPage=1;t.populate()},r,n);e.bind("remove",function(){t.onSubmit=null;s=null})}t.addIncludeDeletedToggle=r;function n(e,t,i){var r=t.onSubmit;var n="";var s="";t.onSubmit=function(e){if(n!=null&&n.length>0){e.params.ContainsText=n}else{delete e.params["ContainsText"]}if(s!=null&&s.length>0){e.params.ContainsField=s}else{delete e.params["ContainsField"]}if(r!=null)return r(e);return true};var o=null;l(e,function(e,i,r){n=i;s=e;t.seekToPage=1;o=r;t.populate()},i);t.onDataLoaded.subscribe(function(e,i){if(o!=null){o(t.getLength()>0);o=null}})}t.addQuickSearchInput=n;function l(t,i,r){var n=$('<div><input type="text"/></div>').addClass("s-QuickSearchBar").prependTo(t);if(r!=null&&r.length>0){n.addClass("has-quick-search-fields")}new e.QuickSearchInput(n.children(),{fields:r,onSearch:i})}t.addQuickSearchInputCustom=l;function s(e,t){var i=new Slick.RowMoveManager({cancelEditOnDrag:true});i.onBeforeMoveRows.subscribe(function(e,t){for(var i=0;!!(i<t.rows.length);i++){if(!!(t.rows[i]===t.insertBefore||t.rows[i]===t.insertBefore-1)){e.stopPropagation();return false}}return true});i.onMoveRows.subscribe(function(i,r){t(r.rows,r.insertBefore);try{e.setSelectedRows([])}catch(n){}});e.registerPlugin(i)}t.makeOrderable=s;function o(e,t,i,r,n){s(e.slickGrid,function(l,s){if(l.length===0){return}var o;var a=s;if(a<0){o=1}else if(s>=e.rowCount()){o=Q.coalesce(i(e.itemAt(e.rowCount()-1)),0);if(o===0){o=s+1}else{o=o+1}}else{o=Q.coalesce(i(e.itemAt(s)),0);if(o===0){o=s+1}}var u=0;var c=null;c=function(){Q.serviceCall({service:r,request:n(t(e.itemAt(l[u])),o++),onSuccess:function(t){u++;if(u<l.length){c()}else{e.view.populate()}}})};c()})}t.makeOrderableWithUpdateRequest=o})(n=e.GridUtils||(e.GridUtils={}));var l;(function(t){function i(e){var t=[];if(e==null){return t}for(var i=0;i<e.length;i++){t.push(r(e[i]))}return t}t.toSlickColumns=i;function r(t){var i={field:t.name,sourceItem:t,cssClass:t.cssClass,headerCssClass:t.headerCssClass,sortable:t.sortable!==false,sortOrder:Q.coalesce(t.sortOrder,0),width:t.width!=null?t.width:80,minWidth:Q.coalesce(t.minWidth,30),maxWidth:t.maxWidth==null||t.maxWidth===0?null:t.maxWidth,resizable:t.resizable==null||!!t.resizable};i.visible=t.visible!==false&&t.filterOnly!==true&&(t.readPermission==null||Q.Authorization.hasPermission(t.readPermission));var r=Q.tryGetText(t.title);if(r==null)r=t.title;i.name=r;if(t.alignment!=null&&t.alignment.length>0){if(!Q.isEmptyOrNull(i.cssClass)){i.cssClass+=" align-"+t.alignment}else{i.cssClass="align-"+t.alignment}}if(t.formatterType!=null&&t.formatterType.length>0){var n=e.FormatterTypeRegistry.get(t.formatterType);var l=new n;if(t.formatterParams!=null){e.ReflectionOptionsSetter.set(l,t.formatterParams)}var s=Q.safeCast(l,e.IInitializeColumn);if(s!=null){s.initializeColumn(i)}i.format=function(e){return l.format(e)}}return i}t.toSlickColumn=r})(l=e.PropertyItemSlickConverter||(e.PropertyItemSlickConverter={}));var s;(function(t){function i(t,i){return e.EnumFormatter.getText(t,i)}t.getEnumText=i;function r(e,t,i){return function(r){var n=i(r);var l=e();var s=Q.coalesce(r.item._indent,0);var o='<span class="s-TreeIndent" style="width:'+15*s+'px"></span>';var a=t(r.item);var u=l.getIdxById(a);var c=l.getItemByIdx(u+1);if(c!=null){var d=Q.coalesce(c._indent,0);if(d>s){if(!!!!r.item._collapsed){return o+'<span class="s-TreeToggle s-TreeExpand"></span>'+n}else{return o+'<span class="s-TreeToggle s-TreeCollapse"></span>'+n}}}return o+'<span class="s-TreeToggle"></span>'+n}}t.treeToggle=r;function n(t){if(t==null){t=Q.Culture.dateFormat}return function(i){return Q.htmlEncode(e.DateFormatter.format(i.value,t))}}t.date=n;function l(t){if(t==null){t=Q.Culture.dateTimeFormat}return function(i){return Q.htmlEncode(e.DateFormatter.format(i.value,t))}}t.dateTime=l;function s(){return function(e){return'<span class="check-box no-float '+(!!e.value?" checked":"")+'"></span>'}}t.checkBox=s;function o(t){return function(i){return e.NumberFormatter.format(i.value,t)}}t.number=o;function a(e){return e.data("item-type")}t.getItemType=a;function u(e){var t=e.data("item-id");return t==null?null:t.toString()}t.getItemId=u;function c(e,t,i,r,n){return"<a"+(t!=null?' href="#'+Q.replaceAll(e,".","-")+"/"+t+'"':"")+' data-item-type="'+Q.attrEncode(e)+'"'+' data-item-id="'+Q.attrEncode(t)+'"'+' class="s-EditLink s-'+Q.replaceAll(e,".","-")+"Link"+(Q.isEmptyOrNull(r)?"":" "+r)+'">'+(n?Q.htmlEncode(Q.coalesce(i,"")):Q.coalesce(i,""))+"</a>"}t.itemLinkText=c;function d(e,t,i,r,n){return function(l){return c(e,l.item[t],i==null?l.value:i(l),r==null?"":r(l),n)}}t.itemLink=d})(s=e.SlickFormatting||(e.SlickFormatting={}));var o;(function(e){function t(e,t){for(var r=0,n=e;r<n.length;r++){var l=n[r];l.sortable=l.sortable!=null?l.sortable:true;var s=l.id;if(s==null){s=l.field}l.id=s;if(t!=null&&l.id!=null&&(l.name==null||Q.startsWith(l.name,"~"))){var o=l.name!=null?l.name.substr(1):l.id;l.name=Q.text(t+o)}if(l.formatter==null&&l.format!=null){l.formatter=i(l.format)}else if(l.formatter==null){l.formatter=function(e,t,i,r,n){return Q.htmlEncode(i)}}}return e}e.setDefaults=t;function i(e){if(e==null){return null}else{return function(t,i,r,n,l){return e({row:t,cell:i,value:r,column:n,item:l})}}}e.convertToFormatter=i})(o=e.SlickHelper||(e.SlickHelper={}));var a;(function(e){function t(e,t){var i=t(e);var r=0;while(i!=null){if(!!i._collapsed){return false}i=t(i);if(r++>1e3){throw new Error("Possible infinite loop, check parents has no circular reference!")}}return true}e.filterCustom=t;function i(e,i,r){return t(e,function(e){var t=r(e);if(t==null){return null}return i.getItemById(t)})}e.filterById=i;function r(e,t){if(e!=null){for(var i=0,r=e;i<r.length;i++){var n=r[i];n._collapsed=t}}}e.setCollapsed=r;function n(e,t){e._collapsed=t}e.setCollapsedFlag=n;function l(e,t,i,r){var n=0;var l={};for(var s=0;s<e.length;s++){var o=e[s];if(s>0){var a=i(o);if(a!=null&&a===t(e[s-1])){n+=1}else if(a==null){n=0}else if(a!==i(e[s-1])){if(l[a]!=null){n=l[a]+1}else{n=0}}}l[t(o)]=n;o._indent=n;if(r!=null){o._collapsed=r}}}e.setIndents=l;function s(e,t,i,n,l){var s=$(e.target);if(!s.hasClass("s-TreeToggle")){return}if(s.hasClass("s-TreeCollapse")||s.hasClass("s-TreeExpand")){var o=n.getItem(t);if(o!=null){if(!!!o._collapsed){o._collapsed=true}else{o._collapsed=false}n.updateItem(l(o),o)}if(e.shiftKey){n.beginUpdate();try{r(n.getItems(),!!o._collapsed);n.setItems(n.getItems(),true)}finally{n.endUpdate()}}}}e.toggleClick=s})(a=e.SlickTreeHelper||(e.SlickTreeHelper={}))})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(){function t(){}t=__decorate([e.Decorators.registerInterface("Serenity.IInitializeColumn")],t);return t}();e.IInitializeColumn=t;var i=e.Decorators.option;function r(t,i){return e.Decorators.registerFormatter("Serenity."+t+"Formatter",i)}var n=function(){function e(){}e.prototype.format=function(e){if(e.value==null){return""}var t;if(!!e.value){t=Q.tryGetText(this.trueText);if(t==null){t=this.trueText;if(t==null){t=Q.coalesce(Q.tryGetText("Dialogs.YesButton"),"Yes")}}}else{t=Q.tryGetText(this.falseText);if(t==null){t=this.falseText;if(t==null){t=Q.coalesce(Q.tryGetText("Dialogs.NoButton"),"No")}}}return Q.htmlEncode(t)};__decorate([i()],e.prototype,"falseText",void 0);__decorate([i()],e.prototype,"trueText",void 0);e=__decorate([r("Boolean")],e);return e}();e.BooleanFormatter=n;var l=function(){function e(){}e.prototype.format=function(e){return'<span class="check-box no-float readonly '+(!!e.value?" checked":"")+'"></span>'};e=__decorate([r("Checkbox")],e);return e}();e.CheckboxFormatter=l;var s=function(){function e(){this.displayFormat=Q.Culture.dateFormat}t=e;e.format=function(e,t){if(e==null){return""}var i;if(e instanceof Date){i=e}else if(typeof e==="string"){i=Q.parseISODateTime(e);if(i==null){return Q.htmlEncode(e)}}else{return e.toString()}return Q.htmlEncode(Q.formatDate(i,t))};e.prototype.format=function(e){return t.format(e.value,this.displayFormat)};var t;__decorate([i()],e.prototype,"displayFormat",void 0);e=t=__decorate([r("Date")],e);return e}();e.DateFormatter=s;var o=function(e){__extends(t,e);function t(){var t=e.call(this)||this;t.displayFormat=Q.Culture.dateTimeFormat;return t}t=__decorate([r("DateTime")],t);return t}(s);e.DateTimeFormatter=o;var a=function(){function t(){}n=t;t.prototype.format=function(t){return n.format(e.EnumTypeRegistry.get(this.enumKey),t.value)};t.format=function(t,i){if(i==null){return""}var r=Q.Enum.toString(t,i);var l=Q.getAttributes(t,e.EnumKeyAttribute,false);var s=l.length>0?l[0].value:Q.getTypeFullName(t);return n.getText(s,r)};t.getText=function(e,t){if(Q.isEmptyOrNull(t)){return""}return Q.htmlEncode(Q.coalesce(Q.tryGetText("Enums."+e+"."+t),t))};t.getName=function(e,t){if(t==null){return""}return Q.Enum.toString(e,t)};var n;__decorate([i()],t.prototype,"enumKey",void 0);t=n=__decorate([r("Enum")],t);return t}();e.EnumFormatter=a;var u=function(){function n(){}l=n;n.prototype.format=function(e){var t=Q.safeCast(e.value,String);if(Q.isEmptyOrNull(t)){return""}var i=l.dbFileUrl(t);var r=!Q.isEmptyOrNull(this.originalNameProperty)?Q.safeCast(e.item[this.originalNameProperty],String):null;r=Q.coalesce(r,"");var n=Q.format(Q.coalesce(this.displayFormat,"{0}"),r,t,i);return"<a class='file-download-link' target='_blank' href='"+Q.attrEncode(i)+"'>"+Q.htmlEncode(n)+"</a>"};n.dbFileUrl=function(e){e=Q.replaceAll(Q.coalesce(e,""),"\\","/");return Q.resolveUrl("~/upload/")+e};n.prototype.initializeColumn=function(e){e.referencedFields=e.referencedFields||[];if(!Q.isEmptyOrNull(this.originalNameProperty)){e.referencedFields.push(this.originalNameProperty);return}};var l;__decorate([i()],n.prototype,"displayFormat",void 0);__decorate([i()],n.prototype,"originalNameProperty",void 0);n=l=__decorate([r("FileDownload",[e.ISlickFormatter,t])],n);return n}();e.FileDownloadFormatter=u;var c=function(){function e(){}t=e;e.prototype.format=function(e){return t.format(e.value)};e.format=function(e){var t=Math.floor(e/60);var i=e-t*60;var r,n;if(e==null||isNaN(e))return"";if(t<10)r="0"+t;else r=t.toString();if(i<10)n="0"+i;else n=i.toString();return Q.format("{0}:{1}",r,n)};var t;e=t=__decorate([r("Minute")],e);return e}();e.MinuteFormatter=c;var d=function(){function e(){}t=e;e.prototype.format=function(e){return t.format(e.value,this.displayFormat)};e.format=function(e,t){t=Q.coalesce(t,"0.##");if(e==null)return"";if(typeof e==="number"){if(isNaN(e))return"";return Q.htmlEncode(Q.formatNumber(e,t))}var i=Q.parseDecimal(e.toString());if(i==null)return"";return Q.htmlEncode(e.toString())};var t;__decorate([i()],e.prototype,"displayFormat",void 0);e=t=__decorate([r("Number")],e);return e}();e.NumberFormatter=d;var p=function(){function n(){}n.prototype.format=function(e){var t=!Q.isEmptyOrNull(this.urlProperty)?Q.coalesce(e.item[this.urlProperty],"").toString():Q.coalesce(e.value,"").toString();if(Q.isEmptyOrNull(t))return"";if(!Q.isEmptyOrNull(this.urlFormat))t=Q.format(this.urlFormat,t);if(t!=null&&Q.startsWith(t,"~/"))t=Q.resolveUrl(t);var i=!Q.isEmptyOrNull(this.displayProperty)?Q.coalesce(e.item[this.displayProperty],"").toString():Q.coalesce(e.value,"").toString();if(!Q.isEmptyOrNull(this.displayFormat))i=Q.format(this.displayFormat,i);var r="<a href='"+Q.attrEncode(t)+"'";if(!Q.isEmptyOrNull(this.target))r+=" target='"+this.target+"'";r+=">"+Q.htmlEncode(i)+"</a>";return r};n.prototype.initializeColumn=function(e){e.referencedFields=e.referencedFields||[];if(!Q.isEmptyOrNull(this.displayProperty)){e.referencedFields.push(this.displayProperty);return}if(!Q.isEmptyOrNull(this.urlProperty)){e.referencedFields.push(this.urlProperty);return}};__decorate([i()],n.prototype,"displayProperty",void 0);__decorate([i()],n.prototype,"displayFormat",void 0);__decorate([i()],n.prototype,"urlProperty",void 0);__decorate([i()],n.prototype,"urlFormat",void 0);__decorate([i()],n.prototype,"target",void 0);n=__decorate([r("Url",[e.ISlickFormatter,t])],n);return n}();e.UrlFormatter=p;var f;(function(t){var i;function r(){var e="formatter";for(var t=0,r=Object.keys(i);t<r.length;t++){var n=r[t];if(!Q.endsWith(n,e))continue;var l=n.substr(0,n.length-e.length);if(Q.isEmptyOrNull(l))continue;if(i[l]!=null)continue;i[l]=i[n]}}function n(){if(i){return}i={};var t=Q.getTypes();for(var n=0,l=t;n<l.length;n++){var s=l[n];if(!Q.isAssignableFrom(e.ISlickFormatter,s))continue;var o=Q.getTypeFullName(s).toLowerCase();i[o]=s;for(var a=0,u=Q.Config.rootNamespaces;a<u.length;a++){var c=u[a];if(Q.startsWith(o,c.toLowerCase()+".")){var d=o.substr(c.length+1).toLowerCase();if(i[d]==null){i[d]=s}}}}r()}function l(e){if(Q.isEmptyOrNull(e))throw new Q.ArgumentNullException("key");n();var t=i[e.toLowerCase()];if(t==null){throw new Q.Exception(Q.format("Can't find {0} formatter type!",e))}return t}t.get=l;function s(){i=null}t.reset=s})(f=e.FormatterTypeRegistry||(e.FormatterTypeRegistry={}))})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(){function t(){}t=__decorate([e.Decorators.registerInterface("Serenity.IDataGrid")],t);return t}();e.IDataGrid=t;var i=function(i){__extends(r,i);function r(e,t){var r=i.call(this,e,t)||this;r.restoringSettings=0;var n=r;r.element.addClass("s-DataGrid").html("");r.element.addClass("s-"+Q.getTypeName(Q.getInstanceType(r)));r.element.addClass("require-layout").bind("layout."+r.uniqueName,function(){n.layout()});r.setTitle(r.getInitialTitle());var l=r.getButtons();if(l!=null){r.createToolbar(l)}r.slickContainer=r.createSlickContainer();r.view=r.createView();r.slickGrid=r.createSlickGrid();if(r.enableFiltering()){r.createFilterBar()}if(r.usePager()){r.createPager()}r.bindToSlickEvents();r.bindToViewEvents();if(l!=null){r.createToolbarExtensions()}r.createQuickFilters();r.updateDisabledState();r.updateInterface();r.initialSettings=r.getCurrentSettings(null);r.restoreSettings(null,null);window.setTimeout(function(){return r.initialPopulate()},0);return r}n=r;r.prototype.attrs=function(e){return Q.getAttributes(Q.getInstanceType(this),e,true)};r.prototype.layout=function(){if(!this.element.is(":visible")||this.slickContainer==null)return;var e=this.element.hasClass("responsive-height");var t=this.slickGrid!=null&&this.slickGrid.getOptions().autoHeight;var i=e&&window.innerWidth<768;if(i){if(this.element[0]&&this.element[0].style.height!="auto")this.element[0].style.height="auto";if(!t){this.slickContainer.css("height","auto").children(".slick-pane").each(function(e,t){if(t.style.height!=null&&t.style.height!="auto")t.style.height="auto"});this.slickGrid.setOptions({autoHeight:true})}}else{if(t){this.slickContainer.children(".slick-viewport").css("height","auto");this.slickGrid.setOptions({autoHeight:false})}Q.layoutFillHeight(this.slickContainer)}this.slickGrid.resizeCanvas()};r.prototype.getInitialTitle=function(){return null};r.prototype.createToolbarExtensions=function(){};r.prototype.ensureQuickFilterBar=function(){if(this.quickFiltersDiv==null)this.createQuickFilters([]);return this.quickFiltersBar};r.prototype.createQuickFilters=function(t){var i=this;if(this.quickFiltersDiv==null&&(t!=null||(t=this.getQuickFilters())&&t!=null&&t.length)){this.quickFiltersDiv=$("<div/>").addClass("quick-filters-bar");if(this.toolbar){$("<div/>").addClass("clear").appendTo(this.toolbar.element);this.quickFiltersDiv.appendTo(this.toolbar.element)}else{this.quickFiltersDiv.appendTo($("<div/>").addClass("s-Toolbar").insertBefore(this.slickContainer))}this.quickFiltersBar=new e.QuickFilterBar(this.quickFiltersDiv,{filters:t,getTitle:function(e){return i.determineText(function(t){return t+e.field})},idPrefix:this.uniqueName+"_QuickFilter_"});this.quickFiltersBar.onChange=function(e){return i.quickFilterChange(e)}}};r.prototype.getQuickFilters=function(){return this.allColumns.filter(function(e){return e.sourceItem&&e.sourceItem.quickFilter===true&&(e.sourceItem.readPermission==null||Q.Authorization.hasPermission(e.sourceItem.readPermission))}).map(function(e){return n.propertyItemToQuickFilter(e.sourceItem)}).filter(function(e){return e!=null})};r.propertyItemToQuickFilter=function(t){var i={};var r=t.name;var n=Q.tryGetText(t.title);if(n==null){n=t.title;if(n==null){n=r}}var l=e.FilteringTypeRegistry.get(Q.coalesce(t.filteringType,"String"));if(l===e.DateFiltering){i=e.QuickFilterBar.dateRange(r,n)}else if(l===e.DateTimeFiltering){i=e.QuickFilterBar.dateTimeRange(r,n)}else if(l===e.BooleanFiltering){var s=t.quickFilterParams||{};var o=t.filteringParams||{};var a=s["trueText"];if(a==null){a=o["trueText"]}var u=s["falseText"];if(u==null){u=o["falseText"]}i=e.QuickFilterBar.boolean(r,n,a,u)}else{var c=new l;if(c&&Q.isInstanceOfType(c,e.IQuickFiltering)){e.ReflectionOptionsSetter.set(c,t.filteringParams);c.set_field(t);c.set_operator({key:e.FilterOperators.EQ});c.initQuickFilter(i);i.options=Q.extend(Q.deepClone(i.options),t.quickFilterParams)}else{return null}}if(!!t.quickFilterSeparator){i.separator=true}i.cssClass=t.quickFilterCssClass;return i};r.prototype.findQuickFilter=function(e,t){if(this.quickFiltersBar!=null)return this.quickFiltersBar.find(e,t);return $("#"+this.uniqueName+"_QuickFilter_"+t).getWidget(e)};r.prototype.tryFindQuickFilter=function(e,t){if(this.quickFiltersBar!=null)return this.quickFiltersBar.tryFind(e,t);var i=$("#"+this.uniqueName+"_QuickFilter_"+t);if(!i.length)return null;return i.tryGetWidget(e)};r.prototype.createIncludeDeletedButton=function(){if(!Q.isEmptyOrNull(this.getIsActiveProperty())||!Q.isEmptyOrNull(this.getIsDeletedProperty())){e.GridUtils.addIncludeDeletedToggle(this.toolbar.element,this.view,null,false)}};r.prototype.getQuickSearchFields=function(){return null};r.prototype.createQuickSearchInput=function(){e.GridUtils.addQuickSearchInput(this.toolbar.element,this.view,this.getQuickSearchFields())};r.prototype.destroy=function(){if(this.quickFiltersBar){this.quickFiltersBar.destroy();this.quickFiltersBar=null}if(this.toolbar){this.toolbar.destroy();this.toolbar=null}if(this.slickGrid){this.slickGrid.onClick.clear();this.slickGrid.onSort.clear();this.slickGrid.onColumnsResized.clear();this.slickGrid.onColumnsReordered.clear();this.slickGrid.destroy();this.slickGrid=null}if(this.view){this.view.onDataChanged.clear();this.view.onSubmit=null;this.view.setFilter(null);this.view=null}this.titleDiv=null;i.prototype.destroy.call(this)};r.prototype.getItemCssClass=function(e,t){var i=this.getIsActiveProperty();var r=this.getIsDeletedProperty();if(Q.isEmptyOrNull(i)&&Q.isEmptyOrNull(r)){return null}if(i){var n=e[i];if(n==null){return null}if(typeof n==="number"){if(n<0){return"deleted"}else if(n===0){return"inactive"}}else if(typeof n==="boolean"){if(n===false){return"deleted"}}}else{return e[r]?"deleted":null}return null};r.prototype.getItemMetadata=function(e,t){var i=this.getItemCssClass(e,t);if(Q.isEmptyOrNull(i)){return new Object}return{cssClasses:i}};r.prototype.postProcessColumns=function(t){e.SlickHelper.setDefaults(t,this.getLocalTextDbPrefix());return t};r.prototype.initialPopulate=function(){var t=this;if(this.populateWhenVisible()){e.LazyLoadHelper.executeEverytimeWhenShown(this.element,function(){t.refreshIfNeeded()},false);if(this.element.is(":visible")&&this.view){this.view.populate()}}else if(this.view){this.view.populate()}};r.prototype.canFilterColumn=function(e){return e.sourceItem!=null&&e.sourceItem.notFilterable!==true&&(e.sourceItem.readPermission==null||Q.Authorization.hasPermission(e.sourceItem.readPermission))};r.prototype.initializeFilterBar=function(){var t=this;this.filterBar.set_store(new e.FilterStore(this.allColumns.filter(function(e){return t.canFilterColumn(e)}).map(function(e){return e.sourceItem})));this.filterBar.get_store().add_changed(function(e,i){if(t.restoringSettings<=0){t.persistSettings(null);t.view&&(t.view.seekToPage=1);t.refresh()}})};r.prototype.createSlickGrid=function(){var e;this.allColumns=this.getColumns();e=this.postProcessColumns(this.allColumns).filter(function(e){return e.visible!==false});var t=this.getSlickOptions();var i=new Slick.Grid(this.slickContainer,this.view,e,t);i.registerPlugin(new Slick.AutoTooltips({enableForHeaderCells:true}));this.slickGrid=i;this.rows=this.slickGrid;this.setInitialSortOrder();return i};r.prototype.setInitialSortOrder=function(){var e=this.getDefaultSortBy();if(this.view){this.view.sortBy=Array.prototype.slice.call(e)}var t=e.map(function(e){var t={};if(e&&Q.endsWith(e.toLowerCase()," desc")){t.columnId=Q.trimEnd(e.substr(0,e.length-5));t.sortAsc=false}else{t.columnId=e;t.sortAsc=true}return t});this.slickGrid.setSortColumns(t)};r.prototype.itemAt=function(e){return this.slickGrid.getDataItem(e)};r.prototype.rowCount=function(){return this.slickGrid.getDataLength()};r.prototype.getItems=function(){return this.view.getItems()};r.prototype.setItems=function(e){this.view.setItems(e,true)};r.prototype.bindToSlickEvents=function(){var e=this;var t=this;this.slickGridOnSort=function(i,r){t.view.populateLock();try{var n=[];var l;if(!!r.multiColumnSort){for(var s=0;!!(s<r.sortCols.length);s++){var o=r.sortCols[s];l=o.sortCol;if(l==null){l={}}n.push(l.field+(!!o.sortAsc?"":" DESC"))}}else{var l=r.sortCol;if(l==null){l={}}n.push(l.field+(!!r.sortAsc?"":" DESC"))}t.view.seekToPage=1;t.view.sortBy=n}finally{t.view.populateUnlock()}t.view.populate();e.persistSettings(null)};this.slickGrid.onSort.subscribe(this.slickGridOnSort);this.slickGridOnClick=function(e,i){t.onClick(e,i.row,i.cell)};this.slickGrid.onClick.subscribe(this.slickGridOnClick);this.slickGrid.onColumnsReordered.subscribe(function(t,i){return e.persistSettings(null)});this.slickGrid.onColumnsResized.subscribe(function(t,i){return e.persistSettings(null)})};r.prototype.getAddButtonCaption=function(){return Q.coalesce(Q.tryGetText("Controls.DataGrid.NewButton"),"New")};r.prototype.getButtons=function(){return[]};r.prototype.editItem=function(e){throw new Error("Not Implemented!")};r.prototype.editItemOfType=function(e,t){if(e===this.getItemType()){this.editItem(t);return}throw new Error("Not Implemented!")};r.prototype.onClick=function(t,i,r){if(t.isDefaultPrevented()){return}var n=$(t.target);if(!n.hasClass("s-EditLink")){n=n.closest("a")}if(n.hasClass("s-EditLink")){t.preventDefault();this.editItemOfType(e.SlickFormatting.getItemType(n),e.SlickFormatting.getItemId(n))}};r.prototype.viewDataChanged=function(e,t){this.markupReady();
this.layout()};r.prototype.bindToViewEvents=function(){var e=this;this.view.onDataChanged.subscribe(function(t,i){return e.viewDataChanged(t,i)});this.view.onSubmit=function(t){return e.onViewSubmit()};this.view.setFilter(function(t,i){return e.onViewFilter(t)});this.view.onProcessData=function(t,i){return e.onViewProcessData(t)}};r.prototype.onViewProcessData=function(e){return e};r.prototype.onViewFilter=function(e){return true};r.prototype.getIncludeColumns=function(e){var t=this.slickGrid.getColumns();for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.field){e[n.field]=true}if(n.referencedFields){for(var l=0,s=n.referencedFields;l<s.length;l++){var o=s[l];e[o]=true}}}};r.prototype.setCriteriaParameter=function(){delete this.view.params["Criteria"];if(this.filterBar){var t=this.filterBar.get_store().get_activeCriteria();if(!e.Criteria.isEmpty(t)){this.view.params.Criteria=t}}};r.prototype.setEquality=function(e,t){Q.setEquality(this.view.params,e,t)};r.prototype.setIncludeColumnsParameter=function(){var e={};this.getIncludeColumns(e);var t=[];for(var i=0,r=Object.keys(e);i<r.length;i++){var n=r[i];t.push(n)}this.view.params.IncludeColumns=t};r.prototype.onViewSubmit=function(){if(this.isDisabled||!this.getGridCanLoad()){return false}this.setCriteriaParameter();this.setIncludeColumnsParameter();this.invokeSubmitHandlers();return true};r.prototype.markupReady=function(){};r.prototype.createSlickContainer=function(){return $('<div class="grid-container"></div>').appendTo(this.element)};r.prototype.createView=function(){var e=this.getViewOptions();return new Slick.RemoteView(e)};r.prototype.getDefaultSortBy=function(){if(this.slickGrid){var e=this.slickGrid.getColumns().filter(function(e){return e.sortOrder&&e.sortOrder!==0});if(e.length>0){e.sort(function(e,t){return e.sortOrder<t.sortOrder?-1:e.sortOrder>t.sortOrder?1:0});var t=[];for(var i=0;i<e.length;i++){var r=e[i];t.push(r.field+(r.sortOrder<0?" DESC":""))}return t}}return[]};r.prototype.usePager=function(){return false};r.prototype.enableFiltering=function(){var t=this.attrs(e.FilterableAttribute);return t.length>0&&t[0].value};r.prototype.populateWhenVisible=function(){return false};r.prototype.createFilterBar=function(){var t=$("<div/>").appendTo(this.element);this.filterBar=new e.FilterDisplayBar(t);this.initializeFilterBar()};r.prototype.getPagerOptions=function(){return{view:this.view,rowsPerPage:20,rowsPerPageOptions:[20,100,500,2500]}};r.prototype.createPager=function(){var e=$("<div></div>").appendTo(this.element);e.slickPager(this.getPagerOptions())};r.prototype.getViewOptions=function(){var e=this;var t={};t.idField=this.getIdProperty();t.sortBy=this.getDefaultSortBy();if(!this.usePager()){t.rowsPerPage=0}else if(this.element.hasClass("responsive-height")){t.rowsPerPage=$(window.window).width()<768?20:100}else{t.rowsPerPage=100}t.getItemMetadata=function(t,i){return e.getItemMetadata(t,i)};return t};r.prototype.createToolbar=function(t){var i=$('<div class="grid-toolbar"></div>').appendTo(this.element);this.toolbar=new e.Toolbar(i,{buttons:t,hotkeyContext:this.element[0]})};r.prototype.getTitle=function(){if(!this.titleDiv){return null}return this.titleDiv.children(".title-text").text()};r.prototype.setTitle=function(e){if(e!==this.getTitle()){if(e==null){if(this.titleDiv){this.titleDiv.remove();this.titleDiv=null}}else{if(!this.titleDiv){this.titleDiv=$('<div class="grid-title"><div class="title-text"></div></div>').prependTo(this.element)}this.titleDiv.children(".title-text").text(e)}this.layout()}};r.prototype.getItemType=function(){return"Item"};r.prototype.itemLink=function(t,i,r,n,l){if(l===void 0){l=true}if(t==null){t=this.getItemType()}if(i==null){i=this.getIdProperty()}return e.SlickFormatting.itemLink(t,i,r,n,l)};r.prototype.getColumnsKey=function(){var t=this.attrs(e.ColumnsKeyAttribute);if(t&&t.length>0){return t[0].value}return null};r.prototype.getPropertyItems=function(){var t=this.attrs(e.ColumnsKeyAttribute);var i=this.getColumnsKey();if(!Q.isEmptyOrNull(i)){return Q.getColumns(i)}return[]};r.prototype.getColumns=function(){var e=this.getPropertyItems();return this.propertyItemsToSlickColumns(e)};r.prototype.propertyItemsToSlickColumns=function(t){var i=e.PropertyItemSlickConverter.toSlickColumns(t);for(var r=0;r<t.length;r++){var n=t[r];var l=i[r];if(n.editLink===true){var s={$:l.format};var o={$:n.editLinkCssClass!=null?n.editLinkCssClass:null};l.format=this.itemLink(n.editLinkItemType!=null?n.editLinkItemType:null,n.editLinkIdField!=null?n.editLinkIdField:null,function(e){if(this.oldFormat.$!=null){return this.oldFormat.$(e)}return Q.htmlEncode(e.value)}.bind({oldFormat:s}),function(e){return Q.coalesce(this.css.$,"")}.bind({css:o}),false);if(!Q.isEmptyOrNull(n.editLinkIdField)){l.referencedFields=l.referencedFields||[];l.referencedFields.push(n.editLinkIdField)}}}return i};r.prototype.getSlickOptions=function(){var t={};t.multiSelect=false;t.multiColumnSort=true;t.enableCellNavigation=false;t.headerRowHeight=e.DataGrid.defaultHeaderHeight;t.rowHeight=e.DataGrid.defaultRowHeight;return t};r.prototype.populateLock=function(){this.view.populateLock()};r.prototype.populateUnlock=function(){this.view.populateUnlock()};r.prototype.getGridCanLoad=function(){return true};r.prototype.refresh=function(){if(!this.populateWhenVisible()){this.internalRefresh();return}if(this.slickContainer.is(":visible")){this.slickContainer.data("needsRefresh",false);this.internalRefresh();return}this.slickContainer.data("needsRefresh",true)};r.prototype.refreshIfNeeded=function(){if(!!this.slickContainer.data("needsRefresh")){this.slickContainer.data("needsRefresh",false);this.internalRefresh()}};r.prototype.internalRefresh=function(){this.view.populate()};r.prototype.setIsDisabled=function(e){if(this.isDisabled!==e){this.isDisabled=e;if(this.isDisabled){this.view.setItems([],true)}this.updateDisabledState()}};Object.defineProperty(r.prototype,"readOnly",{get:function(){return this.get_readOnly()},set:function(e){this.set_readOnly(e)},enumerable:true,configurable:true});r.prototype.get_readOnly=function(){return!!this._readonly};r.prototype.set_readOnly=function(e){if(!!this._readonly!=!!e){this._readonly=!!e;this.updateInterface()}};r.prototype.updateInterface=function(){this.toolbar&&this.toolbar.updateInterface()};r.prototype.getLocalTextDbPrefix=function(){if(this.localTextDbPrefix==null){this.localTextDbPrefix=Q.coalesce(this.getLocalTextPrefix(),"");if(this.localTextDbPrefix.length>0&&!Q.endsWith(this.localTextDbPrefix,".")){this.localTextDbPrefix="Db."+this.localTextDbPrefix+"."}}return this.localTextDbPrefix};r.prototype.getLocalTextPrefix=function(){var t=this.attrs(e.LocalTextPrefixAttribute);if(t.length>=1)return t[0].value;return""};r.prototype.getIdProperty=function(){if(this.idProperty==null){var t=this.attrs(e.IdPropertyAttribute);if(t.length===1){this.idProperty=t[0].value}else{this.idProperty="ID"}}return this.idProperty};r.prototype.getIsDeletedProperty=function(){return null};r.prototype.getIsActiveProperty=function(){if(this.isActiveProperty==null){var t=this.attrs(e.IsActivePropertyAttribute);if(t.length===1){this.isActiveProperty=t[0].value}else{this.isActiveProperty=""}}return this.isActiveProperty};r.prototype.updateDisabledState=function(){this.slickContainer.toggleClass("ui-state-disabled",!!this.isDisabled)};r.prototype.resizeCanvas=function(){this.slickGrid.resizeCanvas()};r.prototype.subDialogDataChange=function(){this.refresh()};r.prototype.addFilterSeparator=function(){this.ensureQuickFilterBar().addSeparator()};r.prototype.determineText=function(e){var t=this.getLocalTextDbPrefix();if(!Q.isEmptyOrNull(t)){var i=Q.tryGetText(e(t));if(i!=null){return i}}return null};r.prototype.addQuickFilter=function(e){return this.ensureQuickFilterBar().add(e)};r.prototype.addDateRangeFilter=function(e,t){return this.ensureQuickFilterBar().addDateRange(e,t)};r.prototype.dateRangeQuickFilter=function(t,i){return e.QuickFilterBar.dateRange(t,i)};r.prototype.addDateTimeRangeFilter=function(e,t){return this.ensureQuickFilterBar().addDateTimeRange(e,t)};r.prototype.dateTimeRangeQuickFilter=function(t,i){return e.QuickFilterBar.dateTimeRange(t,i)};r.prototype.addBooleanFilter=function(e,t,i,r){return this.ensureQuickFilterBar().addBoolean(e,t,i,r)};r.prototype.booleanQuickFilter=function(t,i,r,n){return e.QuickFilterBar.boolean(t,i,r,n)};r.prototype.invokeSubmitHandlers=function(){if(this.quickFiltersBar!=null){this.quickFiltersBar.onSubmit(this.view.params)}};r.prototype.quickFilterChange=function(e){this.persistSettings(null);this.view&&(this.view.seekToPage=1);this.refresh()};r.prototype.getPersistanceStorage=function(){return e.DataGrid.defaultPersistanceStorage};r.prototype.getPersistanceKey=function(){var e="GridSettings:";var t=window.location.pathname;if(!Q.isEmptyOrNull(t)){e+=t.substr(1).split(String.fromCharCode(47)).slice(0,2).join("/")+":"}e+=Q.getTypeFullName(Q.getInstanceType(this));return e};r.prototype.gridPersistanceFlags=function(){return{}};r.prototype.canShowColumn=function(e){if(e==null){return false}var t=e.sourceItem;if(t==null){return true}if(t.filterOnly===true){return false}if(t.readPermission==null){return true}return Q.Authorization.hasPermission(t.readPermission)};r.prototype.getPersistedSettings=function(){var e=this.getPersistanceStorage();if(e==null)return null;var t=Q.trimToNull(e.getItem(this.getPersistanceKey()));if(t!=null&&Q.startsWith(t,"{")&&Q.endsWith(t,"}"))return JSON.parse(t);return null};r.prototype.restoreSettings=function(t,i){var r=this;if(!this.slickGrid)return;if(t==null){t=this.getPersistedSettings();if(t==null)return}var n=this.slickGrid.getColumns();var l=null;var s=function(e){l={};for(var t=0;t<e.length;t++){var i=e[t];l[i.id]=i}};this.view.beginUpdate();this.restoringSettings++;try{i=i||this.gridPersistanceFlags();if(t.columns!=null){if(i.columnVisibility!==false){var o={};s(this.allColumns);var a=[];for(var u=0;u<t.columns.length;u++){var c=t.columns[u];if(c.id!=null&&c.visible===true){var d=l[c.id];if(this.canShowColumn(d)){d.visible=true;a.push(d);delete l[c.id]}}}for(var p=0;p<this.allColumns.length;p++){var f=this.allColumns[p];if(l[f.id]!=null){f.visible=false;a.push(f)}}this.allColumns=a;n=this.allColumns.filter(function(e){return e.visible===true})}if(i.columnWidths!==false){s(n);for(var h=0;h<t.columns.length;h++){var g=t.columns[h];if(g.id!=null&&g.width!=null&&g.width!==0){var m=l[g.id];if(m!=null){m.width=g.width}}}}if(i.sortColumns!==false){s(n);var v=[];var y=t.columns.filter(function(e){return e.id!=null&&Q.coalesce(e.sort,0)!==0});y.sort(function(e,t){return e.sort-t.sort});for(var k=0;k<y.length;k++){var C=y[k];var S=l[C.id];if(S!=null){v.push({columnId:C.id,sortAsc:C.sort>0})}}this.view.sortBy=v.map(function(e){return e.columnId+(e.sortAsc===false?" DESC":"")});this.slickGrid.setSortColumns(v)}this.slickGrid.setColumns(n);this.slickGrid.invalidate()}if(t.filterItems!=null&&i.filterItems!==false&&this.filterBar!=null&&this.filterBar.get_store()!=null){var b=this.filterBar.get_store().get_items();b.length=0;b.push.apply(b,t.filterItems);this.filterBar.get_store().raiseChanged()}if(t.includeDeleted!=null&&i.includeDeleted!==false){var I=this.element.find(".s-IncludeDeletedToggle");if(!!t.includeDeleted!==I.hasClass("pressed")){I.children("a").click()}}if(t.quickFilters!=null&&i.quickFilters!==false&&this.quickFiltersDiv!=null&&this.quickFiltersDiv.length>0){this.quickFiltersDiv.find(".quick-filter-item").each(function(i,n){var l=$(n).data("qffield");if(Q.isEmptyOrNull(l)){return}var s=$("#"+r.uniqueName+"_QuickFilter_"+l).tryGetWidget(e.Widget);if(s==null){return}var o=t.quickFilters[l];var a=$(n).data("qfloadstate");if(a!=null){a(s,o)}else{e.EditorUtils.setValue(s,o)}})}if(i.quickSearch===true&&(t.quickSearchField!=null||t.quickSearchText!=null)){var T=this.toolbar.element.find(".s-QuickSearchInput").first();if(T.length>0){var w=T.tryGetWidget(e.QuickSearchInput);if(w!=null){this.view.populateLock();try{w.element.addClass("ignore-change");try{if(t.quickSearchField!=null){w.set_field(t.quickSearchField)}if(t.quickSearchText!=null&&Q.trimToNull(t.quickSearchText)!==Q.trimToNull(w.element.val())){w.element.val(t.quickSearchText)}}finally{w.element.removeClass("ignore-change");w.element.triggerHandler("execute-search")}}finally{this.view.populateUnlock()}}}}}finally{this.restoringSettings--;this.view.endUpdate()}};r.prototype.persistSettings=function(e){var t=this.getPersistanceStorage();if(!t){return}var i=this.getCurrentSettings(e);t.setItem(this.getPersistanceKey(),$.toJSON(i))};r.prototype.getCurrentSettings=function(t){var i=this;t=t||this.gridPersistanceFlags();var r={};if(t.columnVisibility!==false||t.columnWidths!==false||t.sortColumns!==false){r.columns=[];var n=this.slickGrid.getSortColumns();var l=this.slickGrid.getColumns();for(var s=0,o=l;s<o.length;s++){var a=o[s];var u={id:a.id};if(t.columnVisibility!==false){u.visible=true}if(t.columnWidths!==false){u.width=a.width}if(t.sortColumns!==false){var c=Q.indexOf(n,function(e){return e.columnId==a.id});u.sort=c>=0?n[c].sortAsc!==false?c+1:-c-1:0}r.columns.push(u)}}if(t.includeDeleted!==false){r.includeDeleted=this.element.find(".s-IncludeDeletedToggle").hasClass("pressed")}if(t.filterItems!==false&&this.filterBar!=null&&this.filterBar.get_store()!=null){r.filterItems=this.filterBar.get_store().get_items().slice()}if(t.quickSearch===true){var d=this.toolbar.element.find(".s-QuickSearchInput").first();if(d.length>0){var p=d.tryGetWidget(e.QuickSearchInput);if(p!=null){r.quickSearchField=p.get_field();r.quickSearchText=p.element.val()}}}if(t.quickFilters!==false&&this.quickFiltersDiv!=null&&this.quickFiltersDiv.length>0){r.quickFilters={};this.quickFiltersDiv.find(".quick-filter-item").each(function(n,l){var s=$(l).data("qffield");if(Q.isEmptyOrNull(s)){return}var o=$("#"+i.uniqueName+"_QuickFilter_"+s).tryGetWidget(e.Widget);if(o==null){return}var a=$(l).data("qfsavestate");var u=a!=null?a(o):e.EditorUtils.getValue(o);r.quickFilters[s]=u;if(t.quickFilterText===true&&$(l).hasClass("quick-filter-active")){var c=$(l).data("qfdisplaytext");var d=$(l).find(".quick-filter-label").text();var p;if(c!=null){p=c(o,d)}else{p=d+" = "+e.EditorUtils.getDisplayText(o)}if(!Q.isEmptyOrNull(p)){if(!Q.isEmptyOrNull(r.quickFilterText)){r.quickFilterText+=" "+Q.coalesce(Q.tryGetText("Controls.FilterPanel.And"),"and")+" ";r.quickFilterText+=p}else{r.quickFilterText=p}}}})}return r};r.prototype.getElement=function(){return this.element};r.prototype.getGrid=function(){return this.slickGrid};r.prototype.getView=function(){return this.view};r.prototype.getFilterStore=function(){return this.filterBar==null?null:this.filterBar.get_store()};var n;r=n=__decorate([e.Decorators.registerClass("Serenity.DataGrid",[t,e.IReadOnly]),e.Decorators.element("<div/>")],r);return r}(e.Widget);e.DataGrid=i})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(t){__extends(i,t);function i(){var i=t.call(this)||this;new e.QuickSearchInput(i.byId("Search"),{onSearch:function(e,t,r){t=Q.trimToNull(t);if(t!=null)t=Select2.util.stripDiacritics(t.toLowerCase());i.element.find("li").each(function(e,i){$(i).toggle(!t||Select2.util.stripDiacritics($(i).text().toLowerCase()).indexOf(t)>=0)});r&&r(true)}});i.ulVisible=i.byId("VisibleCols");i.ulHidden=i.byId("HiddenCols");return i}i.createToolButton=function(t){function i(){var i=new e.ColumnPickerDialog;i.allColumns=t.allColumns;if(t.initialSettings){var r=t.initialSettings;if(r.columns&&r.columns.length)i.defaultColumns=r.columns.map(function(e){return e.id})}i.visibleColumns=t.slickGrid.getColumns().map(function(e){return e.id});i.done=function(){t.allColumns=i.allColumns;var e=i.allColumns.filter(function(e){return e.visible===true});t.slickGrid.setColumns(e);t.persistSettings();t.refresh()};Q["Router"]&&Q["Router"].dialog&&Q["Router"].dialog(t.element,i.element,function(){return"columns"});i.dialogOpen()}t.element.on("handleroute."+t.uniqueName,function(e,t){if(t&&!t.handled&&t.route=="columns"){i()}});return{hint:Q.text("Controls.ColumnPickerDialog.Title"),cssClass:"column-picker-button",onClick:i}};i.prototype.getDialogOptions=function(){var e=this;var i=t.prototype.getDialogOptions.call(this);i.title=Q.text("Controls.ColumnPickerDialog.Title");i.width=600;i.buttons=[{text:Q.text("Controls.ColumnPickerDialog.RestoreDefaults"),click:function(){var t={};e.ulVisible.children().add(e.ulHidden.children()).each(function(e,i){var r=$(i);t[r.data("key")]=r});var i=null;for(var r=0,n=e.defaultColumns;r<n.length;r++){var l=n[r];var s=t[l];if(!s)continue;if(i==null)s.prependTo(e.ulVisible);else s.insertAfter(i);i=s;var o=s.data("key");delete t[o]}for(var o in t)t[o].appendTo(e.ulHidden);e.updateListStates()}},{text:Q.text("Dialogs.OkButton"),click:function(){var t=[];for(var i=0,r=e.allColumns;i<r.length;i++){var n=r[i];n.visible=false}e.visibleColumns=e.ulVisible.children().toArray().map(function(i){var r=$(i).data("key");var n=e.colById[r];n.visible=true;t.push(n);return r});for(var l=0,s=e.allColumns;l<s.length;l++){var n=s[l];if(!n.visible)t.push(n)}e.allColumns=t;e.done&&e.done();e.dialogClose()}},{text:Q.text("Dialogs.CancelButton"),click:function(){e.dialogClose()}}];return i};i.prototype.getTitle=function(e){if(e.id=="__select__")return"[x]";return e.name||e.toolTip||e.id};i.prototype.allowHide=function(e){return e.sourceItem==null||e.sourceItem.allowHide==null||e.sourceItem.allowHide};i.prototype.createLI=function(e){var t=this.allowHide(e);return $('\n<li data-key="'+e.id+'" class="'+(t?"":"cant-hide")+'">\n  <span class="drag-handle">☰</span>\n  '+Q.htmlEncode(this.getTitle(e))+"\n  "+(t?'<i class="js-hide" title="'+Q.text("Controls.ColumnPickerDialog.HideHint")+'">✖</i>':"")+'\n  <i class="js-show fa fa-eye" title="'+Q.text("Controls.ColumnPickerDialog.ShowHint")+'"></i>\n</li>')};i.prototype.updateListStates=function(){this.ulVisible.children().removeClass("bg-info").addClass("bg-success");this.ulHidden.children().removeClass("bg-success").addClass("bg-info")};i.prototype.setupColumns=function(){var e=this;this.allColumns=this.allColumns||[];this.visibleColumns=this.visibleColumns||[];var t={};for(var i=0,r=this.visibleColumns;i<r.length;i++){var n=r[i];t[n]=true}this.colById={};for(var l=0,s=this.allColumns;l<s.length;l++){var o=s[l];this.colById[o.id]=o}if(this.defaultColumns==null)this.defaultColumns=this.visibleColumns.slice(0);var a=[];for(var u=0,c=this.allColumns;u<c.length;u++){var d=c[u];if(!t[d.id]&&(!d.sourceItem||d.sourceItem.filterOnly!==true&&(d.sourceItem.readPermission==null||Q.Authorization.hasPermission(d.sourceItem.readPermission)))){a.push(d)}}var p=a.sort(function(t,i){return Q.Culture.stringCompare(e.getTitle(t),e.getTitle(i))});for(var f=0,h=this.visibleColumns;f<h.length;f++){var n=h[f];var g=this.colById[n];if(!g)continue;this.createLI(g).appendTo(this.ulVisible)}for(var m=0,v=p;m<v.length;m++){var y=v[m];this.createLI(y).appendTo(this.ulHidden)}this.updateListStates();if(typeof Sortable!=="undefined"&&Sortable.create){Sortable.create(this.ulVisible[0],{group:this.uniqueName+"_group",filter:".js-hide",onFilter:function(t){$(t.item).appendTo(e.ulHidden);e.updateListStates()},onMove:function(t){if($(t.dragged).hasClass("cant-hide")&&t.from==e.ulVisible[0]&&t.to!==t.from)return false;return true},onEnd:function(t){return e.updateListStates()}});Sortable.create(this.ulHidden[0],{group:this.uniqueName+"_group",sort:false,filter:".js-show",onFilter:function(t){$(t.item).appendTo(e.ulVisible);e.updateListStates()},onEnd:function(t){return e.updateListStates()}})}};i.prototype.onDialogOpen=function(){t.prototype.onDialogOpen.call(this);this.element.find("input").removeAttr("disabled");this.element.closest(".ui-dialog").children(".ui-dialog-buttonpane").find("button").eq(0).addClass("restore-defaults").next().focus();this.setupColumns();Q.centerDialog(this.element)};i.prototype.getTemplate=function(){return'\n<div class="search"><input id="~_Search" type="text" disabled /></div>\n<div class="columns-container">\n<div class="column-list visible-list bg-success">\n  <h5><i class="fa fa-eye"></i> '+Q.text("Controls.ColumnPickerDialog.VisibleColumns")+'</h5>\n  <ul id="~_VisibleCols"></ul>\n</div>\n<div class="column-list hidden-list bg-info">\n  <h5><i class="fa fa-list"></i> '+Q.text("Controls.ColumnPickerDialog.HiddenColumns")+'</h5>\n  <ul id="~_HiddenCols"></ul>\n</div>\n</div>'};i=__decorate([e.Decorators.registerClass(),e.Decorators.resizable(),e.Decorators.responsive()],i);return i}(e.TemplatedDialog);e.ColumnPickerDialog=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i)||this;r.element.addClass("route-handler").on("handleroute."+r.uniqueName,function(e,t){if(!!t.handled)return;if(!!(t.route==="new")){t.handled=true;r.addButtonClick();return}var i=t.route.split("/");if(!!(i.length===2&&i[0]==="edit")){t.handled=true;r.editItem(i[1]);return}if(!!(i.length===2&&i[1]==="new")){t.handled=true;r.editItemOfType(Q.cast(i[0],String),null);return}if(!!(i.length===3&&i[1]==="edit")){t.handled=true;r.editItemOfType(Q.cast(i[0],String),i[2])}});return r}i.prototype.usePager=function(){return true};i.prototype.createToolbarExtensions=function(){this.createIncludeDeletedButton();this.createQuickSearchInput()};i.prototype.getInitialTitle=function(){return this.getDisplayName()};i.prototype.getLocalTextPrefix=function(){var e=t.prototype.getLocalTextPrefix.call(this);if(Q.isEmptyOrNull(e)){return this.getEntityType()}return e};i.prototype.getEntityType=function(){if(this.entityType!=null)return this.entityType;var t=this.attrs(e.EntityTypeAttribute);if(t.length===1){return this.entityType=t[0].value}var i=Q.getTypeFullName(Q.getInstanceType(this));var r=i.indexOf(".");if(r>=0){i=i.substring(r+1)}if(Q.endsWith(i,"Grid")){i=i.substr(0,i.length-4)}else if(Q.endsWith(i,"SubGrid")){i=i.substr(0,i.length-7)}this.entityType=i;return this.entityType};i.prototype.getDisplayName=function(){if(this.displayName!=null)return this.displayName;var e=this.attrs(System.ComponentModel.DisplayNameAttribute);if(e.length>=1){this.displayName=e[0].displayName;this.displayName=Q.LT.getDefault(this.displayName,this.displayName)}else{this.displayName=Q.tryGetText(this.getLocalTextDbPrefix()+"EntityPlural");if(this.displayName==null)this.displayName=this.getEntityType()}return this.displayName};i.prototype.getItemName=function(){if(this.itemName!=null)return this.itemName;var t=this.attrs(e.ItemNameAttribute);if(t.length>=1){this.itemName=t[0].value;this.itemName=Q.LT.getDefault(this.itemName,this.itemName)}else{this.itemName=Q.tryGetText(this.getLocalTextDbPrefix()+"EntitySingular");if(this.itemName==null)this.itemName=this.getEntityType()}return this.itemName};i.prototype.getAddButtonCaption=function(){return Q.format(Q.text("Controls.EntityGrid.NewButton"),this.getItemName())};i.prototype.getButtons=function(){var t=this;var i=[];i.push({title:this.getAddButtonCaption(),cssClass:"add-button",hotkey:"alt+n",onClick:function(){t.addButtonClick()},disabled:function(){return!t.hasInsertPermission()||t.readOnly}});i.push(this.newRefreshButton(true));i.push(e.ColumnPickerDialog.createToolButton(this));return i};i.prototype.newRefreshButton=function(e){var t=this;return{title:e?null:Q.text("Controls.EntityGrid.RefreshButton"),hint:e?Q.text("Controls.EntityGrid.RefreshButton"):null,cssClass:"refresh-button",onClick:function(){t.refresh()}}};i.prototype.addButtonClick=function(){this.editItem(new Object)};i.prototype.editItem=function(t){var i=this;this.createEntityDialog(this.getItemType(),function(r){var n=Q.safeCast(r,e["IEditDialog"]);if(n!=null){n.load(t,function(){n.dialogOpen(i.openDialogsAsPanel)});return}throw new Error(Q.format("{0} doesn't implement IEditDialog!",Q.getTypeFullName(Q.getInstanceType(r))))})};i.prototype.editItemOfType=function(t,i){var r=this;if(t===this.getItemType()){this.editItem(i);return}this.createEntityDialog(t,function(t){var n=Q.safeCast(t,e["IEditDialog"]);if(n!=null){n.load(i,function(){return n.dialogOpen(r.openDialogsAsPanel)});return}throw new Error(Q.format("{0} doesn't implement IEditDialog!",Q.getTypeFullName(Q.getInstanceType(t))))})};i.prototype.getService=function(){if(this.service!=null)return this.service;var t=this.attrs(e.ServiceAttribute);if(t.length>=1)this.service=t[0].value;else this.service=Q.replaceAll(this.getEntityType(),".","/");return this.service};i.prototype.getViewOptions=function(){var e=t.prototype.getViewOptions.call(this);e.url=Q.resolveUrl("~/Services/"+this.getService()+"/List");return e};i.prototype.getItemType=function(){return this.getEntityType()};i.prototype.routeDialog=function(e,t){var i=this;Q["Router"]&&Q["Router"].dialog&&Q["Router"].dialog(this.element,t.element,function(){var r="";if(e!==i.getItemType())r=e+"/";if(!!(t!=null&&t.entityId!=null))r+="edit/"+t.entityId.toString();else r+="new";return r})};i.prototype.getInsertPermission=function(){return null};i.prototype.hasInsertPermission=function(){var e=this.getInsertPermission();return e==null||Q.Authorization.hasPermission(this.getInsertPermission())};i.prototype.transferDialogReadOnly=function(t){if(this.readOnly)e.EditorUtils.setReadOnly(t,true)};i.prototype.initDialog=function(t){var i=this;e.SubDialogHelper.bindToDataChange(t,this,function(e,t){i.subDialogDataChange()},true);this.transferDialogReadOnly(t);this.routeDialog(this.getItemType(),t)};i.prototype.initEntityDialog=function(t,i){var r=this;if(t===this.getItemType()){this.initDialog(i);return}e.SubDialogHelper.bindToDataChange(i,this,function(e,t){r.subDialogDataChange()},true);this.transferDialogReadOnly(i);this.routeDialog(t,i)};i.prototype.createEntityDialog=function(t,i){var r=this;var n=this.getDialogTypeFor(t);var l=e.Widget.create({type:n,options:this.getDialogOptionsFor(t),init:function(e){r.initEntityDialog(t,e);i&&i(e)}});return l};i.prototype.getDialogOptions=function(){return{}};i.prototype.getDialogOptionsFor=function(e){if(e===this.getItemType())return this.getDialogOptions();return{}};i.prototype.getDialogTypeFor=function(t){if(t===this.getItemType()){return this.getDialogType()}return e.DialogTypeRegistry.get(t)};i.prototype.getDialogType=function(){if(this.dialogType!=null)return this.dialogType;var t=this.attrs(e.DialogTypeAttribute);if(t.length>=1)this.dialogType=t[0].value;else this.dialogType=e.DialogTypeRegistry.get(this.getEntityType());return this.dialogType};i=__decorate([e.Decorators.registerClass("Serenity.EntityGrid")],i);return i}(e.DataGrid);e.EntityGrid=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(){function t(i){this.options=i;var r=this.dataGrid=i.grid;var n=r.getIdProperty();var l=this.getId=function(e){return e[n]};r.element.find(".grid-container").on("click",function(t){if($(t.target).hasClass("s-TreeToggle")){var i=r.slickGrid.getCellFromEvent(t);if(i.cell>=0&&i.row>=0){e.SlickTreeHelper.toggleClick(t,i.row,i.row,r.view,l)}}});var s=r.onViewFilter;r.onViewFilter=function(t){if(!s.apply(this,[t]))return false;return e.SlickTreeHelper.filterById(t,r.view,i.getParentId)};var o=r.onViewProcessData;r.onViewProcessData=function(r){r=o.apply(this,[r]);r.Entities=t.applyTreeOrdering(r.Entities,l,i.getParentId);e.SlickTreeHelper.setIndents(r.Entities,l,i.getParentId,i.initialCollapse&&i.initialCollapse()||false);return r};if(i.toggleField){var a=Q.tryFirst(r["allColumns"]||r.slickGrid.getColumns()||[],function(e){return e.field==i.toggleField});if(a){a.format=e.SlickFormatting.treeToggle(function(){return r.view},l,a.format||function(e){return Q.htmlEncode(e.value)});a.formatter=e.SlickHelper.convertToFormatter(a.format)}}}t.prototype.toggleAll=function(){e.SlickTreeHelper.setCollapsed(this.dataGrid.view.getItems(),!this.dataGrid.view.getItems().every(function(e){return e._collapsed==true}));this.dataGrid.view.setItems(this.dataGrid.view.getItems(),true)};t.prototype.collapseAll=function(){e.SlickTreeHelper.setCollapsed(this.dataGrid.view.getItems(),true);this.dataGrid.view.setItems(this.dataGrid.view.getItems(),true)};t.prototype.expandAll=function(){e.SlickTreeHelper.setCollapsed(this.dataGrid.view.getItems(),false);this.dataGrid.view.setItems(this.dataGrid.view.getItems(),true)};t.applyTreeOrdering=function(e,t,i){var r=[];var n=Q.toGrouping(e,t);var l=Q.toGrouping(e,i);var s={};function o(e){if(s[e])return;s[e]=true;for(var i=0,n=l[e]||[];i<n.length;i++){var a=n[i];r.push(a);o(t(a))}}for(var a=0,u=e;a<u.length;a++){var c=u[a];var d=i(c);if(d==null||!(n[d]||[]).length){r.push(c);o(t(c))}}return r};return t}();e.TreeGridMixin=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i)||this;e.addClass("s-CheckTreeEditor");r.updateItems();return r}i.prototype.getIdProperty=function(){return"id"};i.prototype.getTreeItems=function(){return[]};i.prototype.updateItems=function(){var e=this.getTreeItems();var t={};for(var i=0;i<e.length;i++){var r=e[i];r.children=[];if(!Q.isEmptyOrNull(r.id)){t[r.id]=r}if(!Q.isEmptyOrNull(r.parentId)){var n=t[r.parentId];if(n!=null){n.children.push(r)}}}this.view.addData({Entities:e,Skip:0,Take:0,TotalCount:e.length});this.updateSelectAll();this.updateFlags()};i.prototype.getEditValue=function(e,t){if(this.getDelimited())t[e.name]=this.get_value().join(",");else t[e.name]=this.get_value()};i.prototype.setEditValue=function(e,t){var i=e[t.name];this.set_value(i)};i.prototype.getButtons=function(){var t=this;var i=this.getSelectAllText();if(Q.isEmptyOrNull(i)){return null}var r=this;var n=[];n.push(e.GridSelectAllButtonHelper.define(function(){return r},function(e){return e.id},function(e){return e.isSelected},function(e,i){if(e.isSelected!==i){e.isSelected=i;t.itemSelectedChanged(e)}},null,function(){t.updateFlags()}));return n};i.prototype.itemSelectedChanged=function(e){};i.prototype.getSelectAllText=function(){return Q.coalesce(Q.tryGetText("Controls.CheckTreeEditor.SelectAll"),"Select All")};i.prototype.isThreeStateHierarchy=function(){return false};i.prototype.createSlickGrid=function(){this.element.addClass("slick-no-cell-border").addClass("slick-no-odd-even");var e=t.prototype.createSlickGrid.call(this);this.element.addClass("slick-hide-header");e.resizeCanvas();return e};i.prototype.onViewFilter=function(i){if(!t.prototype.onViewFilter.call(this,i)){return false}var r=this.view.getItems();var n=this;return e.SlickTreeHelper.filterCustom(i,function(e){if(e.parentId==null){return null}if(n.byId==null){n.byId={};for(var t=0;t<r.length;t++){var i=r[t];if(i.id!=null){n.byId[i.id]=i}}}return n.byId[e.parentId]})};i.prototype.getInitialCollapse=function(){return false};i.prototype.onViewProcessData=function(i){i=t.prototype.onViewProcessData.call(this,i);this.byId=null;e.SlickTreeHelper.setIndents(i.Entities,function(e){return e.id},function(e){return e.parentId},this.getInitialCollapse());return i};i.prototype.onClick=function(i,r,n){t.prototype.onClick.call(this,i,r,n);if(!i.isDefaultPrevented()){e.SlickTreeHelper.toggleClick(i,r,n,this.view,function(e){return e.id})}if(i.isDefaultPrevented()){return}var l=$(i.target);if(l.hasClass("check-box")){i.preventDefault();if(this._readOnly)return;var s=l.hasClass("checked")||l.hasClass("partial");var o=this.itemAt(r);var a=o.isSelected!==!s;this.view.beginUpdate();try{if(o.isSelected!==!s){o.isSelected=!s;this.view.updateItem(o.id,o);this.itemSelectedChanged(o)}a=this.setAllSubTreeSelected(o,o.isSelected)||a;this.updateSelectAll();this.updateFlags()}finally{this.view.endUpdate()}if(a){this.element.triggerHandler("change")}}};i.prototype.updateSelectAll=function(){e.GridSelectAllButtonHelper.update(this,function(e){return e.isSelected})};i.prototype.updateFlags=function(){var e=this.view;var t=e.getItems();var i=this.isThreeStateHierarchy();if(!i){return}e.beginUpdate();try{for(var r=0;r<t.length;r++){var n=t[r];if(n.children==null||n.children.length===0){var l=this.getDescendantsSelected(n);if(l!==n.isAllDescendantsSelected){n.isAllDescendantsSelected=l;
e.updateItem(n.id,n)}continue}var s=this.allDescendantsSelected(n);var o=s||this.anyDescendantsSelected(n);if(s!==n.isAllDescendantsSelected||o!==n.isSelected){var a=n.isSelected!==o;n.isAllDescendantsSelected=s;n.isSelected=o;e.updateItem(n.id,n);if(a){this.itemSelectedChanged(n)}}}}finally{e.endUpdate()}};i.prototype.getDescendantsSelected=function(e){return true};i.prototype.setAllSubTreeSelected=function(e,t){var i=false;for(var r=0;r<e.children.length;r++){var n=e.children[r];if(n.isSelected!==t){i=true;n.isSelected=t;this.view.updateItem(n.id,n);this.itemSelectedChanged(n)}if(n.children.length>0){i=this.setAllSubTreeSelected(n,t)||i}}return i};i.prototype.allItemsSelected=function(){for(var e=0;e<this.rowCount();e++){var t=this.itemAt(e);if(!t.isSelected){return false}}return this.rowCount()>0};i.prototype.allDescendantsSelected=function(e){if(e.children.length>0){for(var t=0;t<e.children.length;t++){var i=e.children[t];if(!i.isSelected){return false}if(!this.allDescendantsSelected(i)){return false}}}return true};i.prototype.getDelimited=function(){return!!!!this.options["delimited"]};i.prototype.anyDescendantsSelected=function(e){if(e.children.length>0){for(var t=0;t<e.children.length;t++){var i=e.children[t];if(i.isSelected){return true}if(this.anyDescendantsSelected(i)){return true}}}return false};i.prototype.getColumns=function(){var t=this;var i=this;var r=[];r.push({field:"text",name:"Kayıt",width:80,format:e.SlickFormatting.treeToggle(function(){return i.view},function(e){return e.id},function(e){var i="check-box";var r=e.item;if(r.hideCheckBox){return t.getItemText(e)}var n=t.isThreeStateHierarchy();if(r.isSelected){if(n&&!r.isAllDescendantsSelected){i+=" partial"}else{i+=" checked"}}if(t._readOnly)i+=" readonly";return'<span class="'+i+'"></span>'+t.getItemText(e)})});return r};i.prototype.getItemText=function(e){return Q.htmlEncode(e.value)};i.prototype.getSlickOptions=function(){var e=t.prototype.getSlickOptions.call(this);e.forceFitColumns=true;return e};i.prototype.sortItems=function(){if(!this.moveSelectedUp()){return}var e={};var t=this.view.getItems();var i=0;for(var r=0;r<t.length;r++){var n=t[r];e[n.id]=i++}t.sort(function(t,i){if(t.isSelected&&!i.isSelected){return-1}if(i.isSelected&&!t.isSelected){return 1}var r=Q.Culture.stringCompare(t.text,i.text);if(r!==0){return r}return e[t.id]<e[i.id]?-1:e[t.id]>e[i.id]?1:0});this.view.setItems(t,true)};i.prototype.moveSelectedUp=function(){return false};i.prototype.get_readOnly=function(){return this._readOnly};i.prototype.set_readOnly=function(e){if(!!this._readOnly!=!!e){this._readOnly=!!e;this.view.refresh()}};i.prototype.get_value=function(){var e=[];var t=this.view.getItems();for(var i=0;i<t.length;i++){if(t[i].isSelected){e.push(t[i].id)}}return e};Object.defineProperty(i.prototype,"value",{get:function(){return this.get_value()},set:function(e){this.set_value(e)},enumerable:true,configurable:true});i.prototype.set_value=function(e){var t={};if(e!=null){if(typeof e=="string"){e=e.split(",").map(function(e){return Q.trimToNull(e)}).filter(function(e){return e!=null})}for(var i=0;i<e.length;i++){t[e[i]]=true}}this.view.beginUpdate();try{var r=this.view.getItems();for(var n=0;n<r.length;n++){var l=r[n];var s=t[l.id];if(s!==l.isSelected){l.isSelected=s;this.view.updateItem(l.id,l)}}this.updateSelectAll();this.updateFlags();this.sortItems()}finally{this.view.endUpdate()}};i=__decorate([e.Decorators.registerEditor("Serenity.CheckTreeEditor",[e.IGetEditValue,e.ISetEditValue,e.IReadOnly]),e.Decorators.element("<div/>")],i);return i}(e.DataGrid);e.CheckTreeEditor=t;var i=function(t){__extends(i,t);function i(e,i){var r=t.call(this,e,i)||this;r.enableUpdateItems=true;r.setCascadeFrom(r.options.cascadeFrom);r.updateItems();Q.ScriptData.bindToChange("Lookup."+r.getLookupKey(),r.uniqueName,function(){return r.updateItems()});return r}i.prototype.updateItems=function(){if(this.enableUpdateItems)t.prototype.updateItems.call(this)};i.prototype.getLookupKey=function(){return this.options.lookupKey};i.prototype.getButtons=function(){return Q.coalesce(t.prototype.getButtons.call(this),this.options.hideSearch?null:[])};i.prototype.createToolbarExtensions=function(){var i=this;t.prototype.createToolbarExtensions.call(this);e.GridUtils.addQuickSearchInputCustom(this.toolbar.element,function(e,t){i.searchText=Select2.util.stripDiacritics(t||"").toUpperCase();i.view.setItems(i.view.getItems(),true)})};i.prototype.getSelectAllText=function(){if(!this.options.showSelectAll)return null;return t.prototype.getSelectAllText.call(this)};i.prototype.cascadeItems=function(t){var i=this.get_cascadeValue();if(i==null||i===""){if(!Q.isEmptyOrNull(this.get_cascadeField())){return[]}return t}var r=i.toString();var n=this.get_cascadeField();return t.filter(function(t){var i=Q.coalesce(t[n],e.ReflectionUtils.getPropertyValue(t,n));return!!(i!=null&&i.toString()===r)})};i.prototype.filterItems=function(t){var i=this.get_filterValue();if(i==null||i===""){return t}var r=i.toString();var n=this.get_filterField();return t.filter(function(t){var i=Q.coalesce(t[n],e.ReflectionUtils.getPropertyValue(t,n));return!!(i!=null&&i.toString()===r)})};i.prototype.getLookupItems=function(e){return this.filterItems(this.cascadeItems(e.items))};i.prototype.getTreeItems=function(){var e=Q.getLookup(this.options.lookupKey);var t=this.getLookupItems(e);return t.map(function(t){return{id:Q.coalesce(t[e.idField],"").toString(),text:Q.coalesce(t[e.textField],"").toString(),source:t}})};i.prototype.onViewFilter=function(e){return t.prototype.onViewFilter.call(this,e)&&(Q.isEmptyOrNull(this.searchText)||Select2.util.stripDiacritics(e.text||"").toUpperCase().indexOf(this.searchText)>=0)};i.prototype.moveSelectedUp=function(){return this.options.checkedOnTop};i.prototype.get_cascadeFrom=function(){return this.options.cascadeFrom};Object.defineProperty(i.prototype,"cascadeFrom",{get:function(){return this.get_cascadeFrom()},set:function(e){this.set_cascadeFrom(e)},enumerable:true,configurable:true});i.prototype.getCascadeFromValue=function(t){return e.EditorUtils.getValue(t)};i.prototype.setCascadeFrom=function(t){var i=this;if(Q.isEmptyOrNull(t)){if(this.cascadeLink!=null){this.cascadeLink.set_parentID(null);this.cascadeLink=null}this.options.cascadeFrom=null;return}this.cascadeLink=new e.CascadedWidgetLink(e.Widget,this,function(e){i.set_cascadeValue(i.getCascadeFromValue(e))});this.cascadeLink.set_parentID(t);this.options.cascadeFrom=t};i.prototype.set_cascadeFrom=function(e){if(e!==this.options.cascadeFrom){this.setCascadeFrom(e);this.updateItems()}};i.prototype.get_cascadeField=function(){return Q.coalesce(this.options.cascadeField,this.options.cascadeFrom)};Object.defineProperty(i.prototype,"cascadeField",{get:function(){return this.get_cascadeField()},set:function(e){this.set_cascadeField(e)},enumerable:true,configurable:true});i.prototype.set_cascadeField=function(e){this.options.cascadeField=e};i.prototype.get_cascadeValue=function(){return this.options.cascadeValue};Object.defineProperty(i.prototype,"cascadeValue",{get:function(){return this.get_cascadeValue()},set:function(e){this.set_cascadeValue(e)},enumerable:true,configurable:true});i.prototype.set_cascadeValue=function(e){if(this.options.cascadeValue!==e){this.options.cascadeValue=e;this.value=[];this.updateItems()}};i.prototype.get_filterField=function(){return this.options.filterField};Object.defineProperty(i.prototype,"filterField",{get:function(){return this.get_filterField()},set:function(e){this.set_filterField(e)},enumerable:true,configurable:true});i.prototype.set_filterField=function(e){this.options.filterField=e};i.prototype.get_filterValue=function(){return this.options.filterValue};Object.defineProperty(i.prototype,"filterValue",{get:function(){return this.get_filterValue()},set:function(e){this.set_filterValue(e)},enumerable:true,configurable:true});i.prototype.set_filterValue=function(e){if(this.options.filterValue!==e){this.options.filterValue=e;this.value=null;this.updateItems()}};i=__decorate([e.Decorators.registerEditor("Serenity.CheckLookupEditor")],i);return i}(t);e.CheckLookupEditor=i})(Serenity||(Serenity={}));